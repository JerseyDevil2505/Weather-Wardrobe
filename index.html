<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather Wardrobe - Smart Clothing for Any Weather</title>
    <meta
      name="description"
      content="Get personalized clothing recommendations based on current weather conditions"
    />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3B82F6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Weather Wardrobe" />

    <!-- Updated Favicon -->
    <link rel="icon" type="image/png" href="assets/weather_wardrobe_icon.png" />
    <link rel="apple-touch-icon" href="assets/weather_wardrobe_icon.png" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      .weather-icon {
        width: 48px;
        height: 48px;
      }
      .hidden {
        display: none;
      }
      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      .spinner-sm {
        width: 12px;
        height: 12px;
        border: 2px solid rgba(100, 100, 100, 0.3);
        border-top: 2px solid #666;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .suggestion-item {
        padding: 8px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
      }
      .suggestion-item:hover {
        background-color: #f8fafc;
      }
      .suggestion-item:last-child {
        border-bottom: none;
      }
      .app-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-blue-400 via-blue-500 to-blue-600 p-4"
  >
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
        <!-- Header -->
        <div
          class="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white relative overflow-hidden"
        >
          <div class="flex items-center justify-between relative">
            <div class="flex items-center space-x-3">
              <!-- Updated App Icon -->
              <div class="relative">
                <img
                  src="assets/weather_wardrobe_icon.png"
                  alt="Weather Wardrobe"
                  class="app-icon"
                />
              </div>

              <div>
                <h1 class="text-2xl font-bold tracking-wide">
                  Weather Wardrobe
                </h1>
                <p class="text-blue-100 text-sm" id="welcomeText">
                  Smart clothing for any weather
                </p>
              </div>
            </div>

            <button
              onclick="toggleProfile()"
              class="p-3 bg-white bg-opacity-20 rounded-xl hover:bg-opacity-30 transition-all duration-200 backdrop-blur-sm"
              id="profileBtn"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- Profile Setup -->
        <div
          id="profileSection"
          class="hidden p-6 border-b border-gray-200 bg-gray-50"
        >
          <h3 class="text-lg font-semibold mb-4">
            Personalize Your Experience
          </h3>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Your Name</label
              >
              <input
                type="text"
                id="userName"
                placeholder="Enter your name"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Unit Preference</label
              >
              <div class="grid grid-cols-3 gap-2" id="unitPrefs">
                <button
                  onclick="setUnitPref('auto')"
                  class="unit-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700"
                  data-value="auto"
                >
                  <div class="text-lg font-bold">Auto</div>
                  <div class="text-gray-500 text-xs">Based on location</div>
                </button>
                <button
                  onclick="setUnitPref('imperial')"
                  class="unit-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="imperial"
                >
                  <div class="text-lg font-bold">¬∞F, mph</div>
                  <div class="text-gray-500 text-xs">Imperial</div>
                </button>
                <button
                  onclick="setUnitPref('metric')"
                  class="unit-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="metric"
                >
                  <div class="text-lg font-bold">¬∞C, km/h</div>
                  <div class="text-gray-500 text-xs">Metric</div>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Temperature Preference</label
              >
              <div class="grid grid-cols-3 gap-2" id="tempPrefs">
                <button
                  onclick="setTempPref('runs-cold')"
                  class="temp-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="runs-cold"
                >
                  <div class="font-medium">I Run Cold</div>
                  <div class="text-gray-500">Need warmer clothes</div>
                </button>
                <button
                  onclick="setTempPref('average')"
                  class="temp-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700"
                  data-value="average"
                >
                  <div class="font-medium">Average</div>
                  <div class="text-gray-500">Standard comfort</div>
                </button>
                <button
                  onclick="setTempPref('runs-hot')"
                  class="temp-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="runs-hot"
                >
                  <div class="font-medium">I Run Hot</div>
                  <div class="text-gray-500">Need lighter clothes</div>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Activity Level</label
              >
              <div class="grid grid-cols-3 gap-2" id="activityPrefs">
                <button
                  onclick="setActivityLevel('sedentary')"
                  class="activity-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="sedentary"
                >
                  <div class="font-medium">Sedentary</div>
                  <div class="text-gray-500">Office/desk work</div>
                </button>
                <button
                  onclick="setActivityLevel('moderate')"
                  class="activity-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700"
                  data-value="moderate"
                >
                  <div class="font-medium">Moderate</div>
                  <div class="text-gray-500">Some movement</div>
                </button>
                <button
                  onclick="setActivityLevel('active')"
                  class="activity-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="active"
                >
                  <div class="font-medium">Very Active</div>
                  <div class="text-gray-500">Physical work</div>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Style Preference</label
              >
              <div class="grid grid-cols-2 gap-2" id="stylePrefs">
                <button
                  onclick="setStylePref('casual')"
                  class="style-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700"
                  data-value="casual"
                >
                  <div class="font-medium">Casual</div>
                  <div class="text-gray-500">Comfort focused</div>
                </button>
                <button
                  onclick="setStylePref('professional')"
                  class="style-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="professional"
                >
                  <div class="font-medium">Professional</div>
                  <div class="text-gray-500">Business attire</div>
                </button>
                <button
                  onclick="setStylePref('sporty')"
                  class="style-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="sporty"
                >
                  <div class="font-medium">Athletic</div>
                  <div class="text-gray-500">Active wear</div>
                </button>
                <button
                  onclick="setStylePref('fashion')"
                  class="style-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="fashion"
                >
                  <div class="font-medium">Fashion-Forward</div>
                  <div class="text-gray-500">Trend conscious</div>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Work Environment</label
              >
              <div class="grid grid-cols-2 gap-2" id="workPrefs">
                <button
                  onclick="setWorkEnv('indoor')"
                  class="work-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700"
                  data-value="indoor"
                >
                  <div class="font-medium">Indoor Office</div>
                  <div class="text-gray-500">Climate controlled</div>
                </button>
                <button
                  onclick="setWorkEnv('outdoor')"
                  class="work-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="outdoor"
                >
                  <div class="font-medium">Outdoor Work</div>
                  <div class="text-gray-500">Weather exposed</div>
                </button>
                <button
                  onclick="setWorkEnv('mixed')"
                  class="work-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="mixed"
                >
                  <div class="font-medium">Mixed</div>
                  <div class="text-gray-500">Indoor + outdoor</div>
                </button>
                <button
                  onclick="setWorkEnv('home')"
                  class="work-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="home"
                >
                  <div class="font-medium">Work from Home</div>
                  <div class="text-gray-500">Home comfort</div>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Special Considerations</label
              >
              <div class="grid grid-cols-1 gap-2" id="specialPrefs">
                <label
                  class="flex items-center space-x-2 p-2 border rounded-lg hover:bg-gray-50"
                >
                  <input
                    type="checkbox"
                    class="special-checkbox"
                    value="natural-fabrics"
                    onchange="toggleSpecialConsideration('natural-fabrics')"
                  />
                  <span class="text-sm"
                    >Prefer natural fabrics (cotton, wool, linen)</span
                  >
                </label>
                <label
                  class="flex items-center space-x-2 p-2 border rounded-lg hover:bg-gray-50"
                >
                  <input
                    type="checkbox"
                    class="special-checkbox"
                    value="easy-care"
                    onchange="toggleSpecialConsideration('easy-care')"
                  />
                  <span class="text-sm"
                    >Need easy-care/wrinkle-free materials</span
                  >
                </label>
                <label
                  class="flex items-center space-x-2 p-2 border rounded-lg hover:bg-gray-50"
                >
                  <input
                    type="checkbox"
                    class="special-checkbox"
                    value="loose-fit"
                    onchange="toggleSpecialConsideration('loose-fit')"
                  />
                  <span class="text-sm">Prefer loose-fitting clothes</span>
                </label>
                <label
                  class="flex items-center space-x-2 p-2 border rounded-lg hover:bg-gray-50"
                >
                  <input
                    type="checkbox"
                    class="special-checkbox"
                    value="layers"
                    onchange="toggleSpecialConsideration('layers')"
                  />
                  <span class="text-sm">Love layering options</span>
                </label>
              </div>
            </div>

            <button
              onclick="saveProfile()"
              class="w-full mt-4 bg-gradient-to-r from-green-600 to-green-700 text-white py-2 px-4 rounded-lg font-medium hover:from-green-700 hover:to-green-800 transition-all"
            >
              Save Preferences
            </button>
          </div>
        </div>

        <!-- Location Input -->
        <div class="p-6">
          <!-- Saved Location Display -->
          <div id="savedLocationDiv" class="hidden mb-6">
            <div
              class="flex items-center justify-between bg-blue-50 rounded-xl p-4 border border-blue-200"
            >
              <div class="flex items-center space-x-3">
                <svg
                  class="w-5 h-5 text-blue-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                <div>
                  <p class="text-sm text-blue-600 font-medium">Your Location</p>
                  <p
                    class="text-blue-800 font-semibold"
                    id="savedLocationText"
                  ></p>
                </div>
              </div>
              <button
                onclick="editLocation()"
                class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                  />
                </svg>
              </button>
            </div>

            <button
              onclick="getWeather()"
              class="w-full mt-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-6 rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
              id="quickWeatherBtn"
            >
              Get Today's Clothing Advice
            </button>
          </div>

          <!-- Location Input Form -->
          <div id="locationInputDiv" class="mb-6">
            <div class="relative">
              <svg
                class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5 z-10"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
              <input
                type="text"
                id="locationInput"
                placeholder="Enter city name or zip code"
                autocomplete="off"
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                oninput="handleLocationInput(this.value)"
                onblur="setTimeout(() => hideLocationSuggestions(), 150)"
                onfocus="showRecentSuggestions()"
              />

              <!-- Autocomplete Dropdown -->
              <div
                id="locationSuggestions"
                class="hidden absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"
              >
                <div id="suggestionsList" class="py-1"></div>
                <div
                  id="loadingSuggestion"
                  class="hidden px-4 py-2 text-sm text-gray-500 flex items-center"
                >
                  <div class="spinner-sm mr-2"></div>
                  Searching locations...
                </div>
              </div>
            </div>

            <button
              onclick="getWeather()"
              class="w-full mt-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-6 rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
              id="getWeatherBtn"
            >
              Get Clothing Advice
            </button>
          </div>

          <!-- Error Display -->
          <div
            id="errorDiv"
            class="hidden bg-red-50 border border-red-200 rounded-xl p-4 mb-6"
          >
            <p class="text-red-700 text-sm" id="errorText"></p>
          </div>

          <!-- Weather Results -->
          <div id="weatherResults" class="hidden space-y-6">
            <!-- Weather Info -->
            <div
              class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100"
            >
              <div class="flex items-start justify-between mb-6">
                <div class="flex-1">
                  <h2
                    class="text-lg font-medium text-gray-700 mb-1"
                    id="weatherLocation"
                  ></h2>
                  <div class="flex items-baseline space-x-1 mb-2">
                    <span
                      class="text-5xl font-bold text-blue-700"
                      id="weatherTemp"
                    ></span>
                  </div>
                  <p
                    class="text-lg font-medium text-gray-600 capitalize"
                    id="weatherCondition"
                  ></p>
                </div>
                <div class="text-right ml-4" id="weatherIcon"></div>
              </div>

              <div class="grid grid-cols-3 gap-6 pt-4 border-t border-blue-200">
                <div class="text-center">
                  <div class="flex justify-center mb-2">
                    <svg
                      class="w-6 h-6 text-orange-500"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                      />
                    </svg>
                  </div>
                  <p
                    class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1"
                  >
                    Feels like
                  </p>
                  <p class="text-lg font-bold text-gray-800" id="feelsLike"></p>
                </div>
                <div class="text-center">
                  <div class="flex justify-center mb-2">
                    <svg
                      class="w-6 h-6 text-blue-500"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                      />
                    </svg>
                  </div>
                  <p
                    class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1"
                  >
                    Humidity
                  </p>
                  <p class="text-lg font-bold text-gray-800" id="humidity"></p>
                </div>
                <div class="text-center">
                  <div class="flex justify-center mb-2">
                    <svg
                      class="w-6 h-6 text-gray-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  </div>
                  <p
                    class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1"
                  >
                    Wind
                  </p>
                  <p class="text-lg font-bold text-gray-800" id="windSpeed"></p>
                </div>
              </div>

              <!-- Today's Forecast Section -->
              <div id="todaysForecast" class="hidden"></div>
            </div>

            <!-- Clothing Recommendation -->
            <div
              class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6 border border-green-200"
            >
              <div class="flex items-center mb-4">
                <svg
                  class="w-6 h-6 text-green-700 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  />
                </svg>
                <h3 class="text-lg font-semibold text-green-800">
                  What to Wear
                </h3>
              </div>

              <!-- Clothing Categories -->
              <div class="space-y-4 mb-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <!-- Upper Body -->
                  <div class="bg-white bg-opacity-60 rounded-lg p-3">
                    <div class="flex items-center mb-2">
                      <svg
                        class="w-4 h-4 text-green-600 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"
                        />
                      </svg>
                      <h4 class="font-medium text-green-800 text-sm">
                        Upper Body
                      </h4>
                    </div>
                    <p
                      class="text-green-700 text-sm"
                      id="topRecommendation"
                    ></p>
                  </div>

                  <!-- Lower Body -->
                  <div class="bg-white bg-opacity-60 rounded-lg p-3">
                    <div class="flex items-center mb-2">
                      <svg
                        class="w-4 h-4 text-green-600 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <h4 class="font-medium text-green-800 text-sm">
                        Lower Body
                      </h4>
                    </div>
                    <p
                      class="text-green-700 text-sm"
                      id="bottomRecommendation"
                    ></p>
                  </div>

                  <!-- Footwear -->
                  <div class="bg-white bg-opacity-60 rounded-lg p-3">
                    <div class="flex items-center mb-2">
                      <svg
                        class="w-4 h-4 text-green-600 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-1m6-4V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        />
                      </svg>
                      <h4 class="font-medium text-green-800 text-sm">
                        Footwear
                      </h4>
                    </div>
                    <p
                      class="text-green-700 text-sm"
                      id="footwearRecommendation"
                    ></p>
                  </div>

                  <!-- Accessories -->
                  <div class="bg-white bg-opacity-60 rounded-lg p-3">
                    <div class="flex items-center mb-2">
                      <svg
                        class="w-4 h-4 text-green-600 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <h4 class="font-medium text-green-800 text-sm">
                        Accessories
                      </h4>
                    </div>
                    <p
                      class="text-green-700 text-sm"
                      id="accessoriesRecommendation"
                    ></p>
                  </div>
                </div>
              </div>

              <!-- Weather-specific alerts -->
              <div
                id="weatherAlerts"
                class="hidden bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4"
              >
                <div class="flex items-start">
                  <svg
                    class="w-4 h-4 text-amber-600 mr-2 mt-0.5 flex-shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.966-.833-2.736 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
                    />
                  </svg>
                  <p class="text-amber-800 text-sm" id="weatherAlertText"></p>
                </div>
              </div>

              <div
                id="personalizedNote"
                class="hidden bg-white bg-opacity-70 rounded-lg p-3 text-sm"
              >
                <div class="flex items-start">
                  <svg
                    class="w-4 h-4 text-green-600 mr-2 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                    />
                  </svg>
                  <div>
                    <p class="text-green-600 font-medium">
                      Personalized for you!
                    </p>
                    <p class="text-green-600">
                      Recommendations adjusted for your preferences and activity
                      level.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Refresh Button -->
            <button
              onclick="getWeather()"
              class="w-full bg-gray-100 text-gray-700 py-3 px-6 rounded-xl font-medium hover:bg-gray-200 transition-colors duration-200"
            >
              Refresh Weather
            </button>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center mt-6 text-white text-sm opacity-75">
        <p>Stay comfortable, dress smart! üå§Ô∏è</p>
      </div>
    </div>

    <script>
      // Global state
      let userProfile = {
        name: "",
        temperaturePreference: "average",
        activityLevel: "moderate",
        stylePreference: "casual",
        workEnvironment: "indoor",
        specialConsiderations: [],
        unitPreference: "auto", // auto, imperial, metric
        hasLearned: false,
      };
      let savedLocation = "";
      let isShowingProfile = false;
      let currentUnits = "imperial"; // imperial or metric
      let currentCountry = null;

      // Load saved data on page load
      window.addEventListener("load", function () {
        loadUserData();
        updateUI();
      });

      function loadUserData() {
        console.log("üì± loadUserData called");
        try {
          const profile = localStorage.getItem("weatherWardrobeProfile");
          console.log("üì± Raw profile from localStorage:", profile);

          if (profile) {
            userProfile = JSON.parse(profile);
            console.log("üì± Parsed userProfile:", userProfile);

            // Ensure specialConsiderations is always an array
            if (!Array.isArray(userProfile.specialConsiderations)) {
              userProfile.specialConsiderations = [];
            }
            // Ensure unitPreference has a default value
            if (!userProfile.unitPreference) {
              userProfile.unitPreference = "auto";
              console.log("üì± Set default unitPreference to 'auto'");
            }
          } else {
            console.log("üì± No profile found in localStorage, using defaults");
          }

          const location = localStorage.getItem("weatherWardrobeLocation");
          if (location) {
            savedLocation = location;
            document.getElementById("locationInput").value = location;
            console.log("üì± Loaded saved location:", location);
          }

          console.log("üì± Final userProfile after load:", userProfile);
        } catch (e) {
          console.log("üì± Storage not available:", e);
        }
      }

      // Unit detection based on country and user preference
      function detectUnits(country) {
        // Check user preference first
        if (userProfile.unitPreference === 'imperial') {
          return 'imperial';
        } else if (userProfile.unitPreference === 'metric') {
          return 'metric';
        }

        // Auto mode: detect based on country
        // Imperial countries: US, Liberia, Myanmar (Burma)
        const imperialCountries = ['US', 'LR', 'MM'];
        return imperialCountries.includes(country) ? 'imperial' : 'metric';
      }

      // Refresh weather display with new units
      function refreshWeatherWithNewUnits() {
        const locationInput = document.getElementById("locationInput");
        const currentLocation = locationInput.value.trim() || savedLocation;

        if (currentLocation) {
          console.log("Refreshing weather with new units:", userProfile.unitPreference, "currentUnits:", currentUnits);
          getWeather();
        }
      }

      // Temperature conversion functions
      function fahrenheitToCelsius(fahrenheit) {
        return (fahrenheit - 32) * 5/9;
      }

      function celsiusToFahrenheit(celsius) {
        return (celsius * 9/5) + 32;
      }

      // Wind speed conversion functions
      function mphToKmh(mph) {
        return mph * 1.60934;
      }

      function formatTemperature(temp, units = currentUnits) {
        const rounded = Math.round(temp);
        return units === 'metric' ? `${rounded}¬∞C` : `${rounded}¬∞F`;
      }

      function formatWindSpeed(speed, units = currentUnits) {
        const rounded = Math.round(speed);
        return units === 'metric' ? `${rounded} km/h` : `${rounded} mph`;
      }

      function updateUI() {
        // Update welcome text
        const welcomeText = document.getElementById("welcomeText");
        if (userProfile.name) {
          welcomeText.textContent = `Hello, ${userProfile.name}!`;
        }

        // Update location display
        if (savedLocation) {
          document.getElementById("savedLocationText").textContent =
            savedLocation;
          document
            .getElementById("savedLocationDiv")
            .classList.remove("hidden");
          document.getElementById("locationInputDiv").classList.add("hidden");
        } else {
          document.getElementById("savedLocationDiv").classList.add("hidden");
          document
            .getElementById("locationInputDiv")
            .classList.remove("hidden");
        }

        // Update profile form
        if (userProfile.name) {
          document.getElementById("userName").value = userProfile.name;
        }

        // Load recent locations for autocomplete
        loadRecentLocations();

        // Update temperature preference buttons
        document.querySelectorAll(".temp-btn").forEach((btn) => {
          const value = btn.getAttribute("data-value");
          if (value === userProfile.temperaturePreference) {
            btn.className =
              "temp-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700";
          } else {
            btn.className =
              "temp-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300";
          }
        });

        // Update activity level buttons
        document.querySelectorAll(".activity-btn").forEach((btn) => {
          const value = btn.getAttribute("data-value");
          if (value === userProfile.activityLevel) {
            btn.className =
              "activity-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700";
          } else {
            btn.className =
              "activity-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300";
          }
        });

        // Update style preference buttons
        document.querySelectorAll(".style-btn").forEach((btn) => {
          const value = btn.getAttribute("data-value");
          if (value === userProfile.stylePreference) {
            btn.className =
              "style-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700";
          } else {
            btn.className =
              "style-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300";
          }
        });

        // Update work environment buttons
        document.querySelectorAll(".work-btn").forEach((btn) => {
          const value = btn.getAttribute("data-value");
          if (value === userProfile.workEnvironment) {
            btn.className =
              "work-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700";
          } else {
            btn.className =
              "work-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300";
          }
        });

        // Update unit preference buttons
        console.log("ÔøΩÔøΩÔøΩÔ∏è Updating unit preference buttons - current preference:", userProfile.unitPreference);
        document.querySelectorAll(".unit-btn").forEach((btn) => {
          const value = btn.getAttribute("data-value");
          console.log("üéõÔ∏è Button:", value, "matches current pref?", value === userProfile.unitPreference);
          if (value === userProfile.unitPreference) {
            btn.className =
              "unit-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700";
          } else {
            btn.className =
              "unit-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300";
          }
        });

        // Update special considerations checkboxes
        document.querySelectorAll(".special-checkbox").forEach((checkbox) => {
          const value = checkbox.value;
          checkbox.checked =
            userProfile.specialConsiderations &&
            userProfile.specialConsiderations.includes(value);
        });
      }

      function toggleProfile() {
        const profileSection = document.getElementById("profileSection");
        isShowingProfile = !isShowingProfile;

        if (isShowingProfile) {
          profileSection.classList.remove("hidden");
        } else {
          profileSection.classList.add("hidden");
        }
      }

      function setTempPref(pref) {
        userProfile.temperaturePreference = pref;
        updateUI();
      }

      function setActivityLevel(level) {
        userProfile.activityLevel = level;
        updateUI();
      }

      function setStylePref(style) {
        userProfile.stylePreference = style;
        updateUI();
      }

      function setWorkEnv(env) {
        userProfile.workEnvironment = env;
        updateUI();
      }

      function setUnitPref(unit) {
        console.log("üîß setUnitPref called with:", unit);
        console.log("üîß Before change - userProfile.unitPreference:", userProfile.unitPreference);
        console.log("üîß Before change - currentUnits:", currentUnits);

        userProfile.unitPreference = unit;

        // Immediately update current units if not auto
        if (unit !== 'auto') {
          currentUnits = unit;
        } else if (currentCountry) {
          currentUnits = detectUnits(currentCountry);
        }

        console.log("üîß After change - userProfile.unitPreference:", userProfile.unitPreference);
        console.log("üîß After change - currentUnits:", currentUnits);
        updateUI();

        // If weather is currently displayed, refresh with new units
        if (!document.getElementById("weatherResults").classList.contains("hidden")) {
          console.log("üîß Weather is displayed, refreshing with new units");
          refreshWeatherWithNewUnits();
        } else {
          console.log("üîß Weather not displayed, skipping refresh");
        }
      }

      function toggleSpecialConsideration(consideration) {
        const index = userProfile.specialConsiderations.indexOf(consideration);
        if (index > -1) {
          userProfile.specialConsiderations.splice(index, 1);
        } else {
          userProfile.specialConsiderations.push(consideration);
        }
      }

      function saveProfile() {
        console.log("üíæ saveProfile called");
        console.log("üíæ Current userProfile before save:", JSON.stringify(userProfile, null, 2));

        const name = document.getElementById("userName").value;
        userProfile.name = name;
        userProfile.hasLearned = true;

        try {
          localStorage.setItem(
            "weatherWardrobeProfile",
            JSON.stringify(userProfile),
          );
          console.log("üíæ Profile saved to localStorage");
        } catch (e) {
          console.log("üíæ Cannot save to storage");
        }

        toggleProfile();
        updateUI();
        console.log("üíæ saveProfile completed");
      }

      function editLocation() {
        // Clear saved location temporarily to force using input field
        savedLocation = "";

        document.getElementById("savedLocationDiv").classList.add("hidden");
        document.getElementById("locationInputDiv").classList.remove("hidden");

        const locationInput = document.getElementById("locationInput");
        locationInput.focus();
        locationInput.select(); // Select all text for easy replacement

        console.log("Edit mode activated, savedLocation cleared"); // Debug log
      }

      function getSimpleForecast(currentData) {
        // Create a simple forecast based on current weather when detailed forecast fails
        const currentTemp = Math.round(currentData.main.temp);
        const alerts = [];

        // Generate some basic forecast info
        const high = currentTemp + Math.floor(Math.random() * 10) + 2; // 2-12 degrees higher
        const low = currentTemp - Math.floor(Math.random() * 15) - 5; // 5-20 degrees lower

        // Add some basic alerts based on current conditions
        if (currentData.weather[0].main.toLowerCase().includes("thunder")) {
          alerts.push(
            "Thunderstorms possible - bring an umbrella and avoid outdoor activities!",
          );
        }
        if (currentData.wind?.speed > 10) {
          alerts.push(
            "Windy conditions continuing - secure clothing and accessories!",
          );
        }
        if (high - currentTemp > 8) {
          alerts.push(
            `Temperature may rise to ${formatTemperature(high)} later - dress in layers!`,
          );
        }

        return {
          high,
          low,
          afternoon: currentData.weather[0].main,
          evening: currentData.weather[0].main,
          alerts:
            alerts.length > 0
              ? alerts
              : [`High: ${high}¬∞F, Low: ${low}¬∞F expected today`],
        };
      }

      function getTodaysForecast(forecastData) {
        if (
          !forecastData ||
          !forecastData.list ||
          forecastData.list.length === 0
        ) {
          console.log("No forecast data available"); // Debug log
          return null;
        }

        const today = new Date();
        const todayStr = today.toISOString().split("T")[0]; // YYYY-MM-DD format

        // Filter today's forecast entries (3-hour intervals)
        const todaysEntries = forecastData.list.filter((entry) => {
          const entryDate = new Date(entry.dt * 1000)
            .toISOString()
            .split("T")[0];
          return entryDate === todayStr;
        });

        console.log("Today entries found:", todaysEntries.length); // Debug log

        if (todaysEntries.length === 0) {
          // If no entries for today, use tomorrow's data
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          const tomorrowStr = tomorrow.toISOString().split("T")[0];

          const tomorrowEntries = forecastData.list
            .filter((entry) => {
              const entryDate = new Date(entry.dt * 1000)
                .toISOString()
                .split("T")[0];
              return entryDate === tomorrowStr;
            })
            .slice(0, 3); // Just first 3 entries of tomorrow

          if (tomorrowEntries.length === 0) {
            return null;
          }

          const temps = tomorrowEntries.map((entry) => entry.main.temp);
          return {
            high: Math.round(Math.max(...temps)),
            low: Math.round(Math.min(...temps)),
            afternoon: tomorrowEntries[0]?.weather[0].main || "Unknown",
            evening: tomorrowEntries[1]?.weather[0].main || "Unknown",
            alerts: ["Showing tomorrow's forecast"],
          };
        }

        // Find high and low temps for today
        const temps = todaysEntries.map((entry) => entry.main.temp);
        const high = Math.round(Math.max(...temps));
        const low = Math.round(Math.min(...temps));

        // Get afternoon and evening conditions
        const currentHour = today.getHours();
        const afternoonEntry = todaysEntries.find((entry) => {
          const hour = new Date(entry.dt * 1000).getHours();
          return hour >= 14 && hour <= 17; // 2 PM - 5 PM
        });
        const eveningEntry = todaysEntries.find((entry) => {
          const hour = new Date(entry.dt * 1000).getHours();
          return hour >= 18 && hour <= 21; // 6 PM - 9 PM
        });

        // Generate alerts based on forecast
        const alerts = [];

        // Check for rain/snow later
        const laterEntries = todaysEntries.filter((entry) => {
          const hour = new Date(entry.dt * 1000).getHours();
          return hour > currentHour;
        });

        const rainLater = laterEntries.some(
          (entry) =>
            entry.weather[0].main.toLowerCase().includes("rain") ||
            entry.weather[0].main.toLowerCase().includes("drizzle"),
        );
        const snowLater = laterEntries.some((entry) =>
          entry.weather[0].main.toLowerCase().includes("snow"),
        );
        const windyLater = laterEntries.some(
          (entry) => (entry.wind?.speed || 0) > 15,
        );

        if (rainLater)
          alerts.push(
            "Rain expected later today - consider bringing an umbrella!",
          );
        if (snowLater)
          alerts.push("Snow expected later - pack extra warm layers!");
        if (windyLater)
          alerts.push("Getting windier later - consider a windbreaker!");

        // Temperature change alerts
        const currentTemp = Math.round(todaysEntries[0]?.main.temp || 0);
        if (high - currentTemp > 10) {
          alerts.push(`Warming up significantly - high of ${formatTemperature(high)} expected!`);
        }
        if (currentTemp - low > 10 && currentHour < 18) {
          alerts.push(`Cooling down later - low of ${formatTemperature(low)} tonight!`);
        }

        // If no specific alerts, add a general one
        if (alerts.length === 0) {
          alerts.push(`High: ${formatTemperature(high)}, Low: ${formatTemperature(low)} expected today`);
        }

        return {
          high,
          low,
          afternoon: afternoonEntry?.weather[0].main || "Similar conditions",
          evening: eveningEntry?.weather[0].main || "Similar conditions",
          alerts,
        };
      }

      async function getWeather() {
        console.log("getWeather function called!"); // Debug log
        const locationInput = document.getElementById("locationInput");
        const inputValue = locationInput.value.trim();

        console.log("getWeather called with input:", inputValue); // Debug log
        console.log("savedLocation:", savedLocation); // Debug log

        // Use input field value if it exists and we're not in saved mode
        const location = inputValue || savedLocation;

        if (!location) {
          showError("Please enter a location");
          return;
        }

        // Smart location handling
        let enhancedLocation = location;
        let useCoordinates = false;
        let preferredLocationName = null;

        // If user selected a location from autocomplete, use coordinates for precise results
        if (selectedLocation && selectedLocation.lat && selectedLocation.lon) {
          enhancedLocation = `lat=${selectedLocation.lat}&lon=${selectedLocation.lon}`;
          useCoordinates = true;
          // Preserve the full location name with state
          preferredLocationName = formatLocationName(selectedLocation);
          console.log(
            "Using coordinates for precise location:",
            enhancedLocation,
            "with preferred name:",
            preferredLocationName,
          );
        } else {
          // For direct input (like zip codes or typed cities), use the text as-is
          enhancedLocation = location;
          useCoordinates = false;
          console.log("Using text-based location:", enhancedLocation);
        }

        // Reset selectedLocation for next search
        selectedLocation = null;

        console.log("Final location to search:", enhancedLocation); // Debug log

        // Show loading state
        const button =
          document.getElementById("getWeatherBtn") ||
          document.getElementById("quickWeatherBtn");
        if (button) {
          const originalText = button.textContent;
          button.innerHTML = '<div class="spinner mx-auto"></div>';
          button.disabled = true;
        }

        hideError();

        try {
          // Use secure serverless function instead of direct API calls
          console.log("Using secure API for:", location); // Debug log

          // Respect user's manual preference, only auto-detect if set to "auto"
          if (userProfile.unitPreference !== 'auto') {
            // User manually chose Imperial or Metric - respect their choice
            currentUnits = userProfile.unitPreference;
          } else {
            // Auto mode - detect based on location
            let detectedUnits = 'imperial';
            if (selectedLocation && selectedLocation.country) {
              detectedUnits = detectUnits(selectedLocation.country);
              currentCountry = selectedLocation.country;
            }
            currentUnits = detectedUnits;
          }

          console.log("Using units:", currentUnits, "for country:", currentCountry);

          // Get current weather through secure API with appropriate units
          const currentUrl = useCoordinates
            ? `/api/weather?${enhancedLocation}&type=current&units=${currentUnits}`
            : `/api/weather?location=${encodeURIComponent(enhancedLocation)}&type=current&units=${currentUnits}`;

          const currentResponse = await fetch(currentUrl);

          const currentData = await currentResponse.json();
          console.log("Current weather from secure API:", currentData); // Debug log

          if (currentResponse.ok) {
            // Get today's forecast through secure API
            let forecastData = null;
            try {
              const forecastUrl = useCoordinates
                ? `/api/weather?${enhancedLocation}&type=forecast&units=${currentUnits}`
                : `/api/weather?location=${encodeURIComponent(enhancedLocation)}&type=forecast&units=${currentUnits}`;

              const forecastResponse = await fetch(forecastUrl);

              if (forecastResponse.ok) {
                forecastData = await forecastResponse.json();
                console.log(
                  "Forecast data received from secure API:",
                  forecastData,
                ); // Debug log
              } else {
                console.log("Forecast API failed, continuing without forecast"); // Debug log
              }
            } catch (forecastError) {
              console.log("Forecast API error:", forecastError); // Debug log
            }

            // Process today's forecast
            const todaysForecast = forecastData
              ? getTodaysForecast(forecastData)
              : getSimpleForecast(currentData);
            console.log("Processed forecast:", todaysForecast); // Debug log

            // Store country info but don't override manual unit preference
            if (currentData.sys && currentData.sys.country) {
              const apiCountry = currentData.sys.country;
              if (!currentCountry || currentCountry !== apiCountry) {
                currentCountry = apiCountry;

                // Only auto-detect units if user preference is set to "auto"
                if (userProfile.unitPreference === 'auto') {
                  const newUnits = detectUnits(apiCountry);
                  if (newUnits !== currentUnits) {
                    currentUnits = newUnits;
                    console.log("Auto-detected units based on API response:", currentUnits, "for country:", currentCountry);
                  }
                } else {
                  console.log("Keeping manual unit preference:", currentUnits, "for country:", currentCountry);
                }
              }
            }

            // Use preferred location name from autocomplete or format from API response
            let locationDisplay;
            if (preferredLocationName) {
              // Use the full name from autocomplete selection (includes state)
              locationDisplay = preferredLocationName;
            } else {
              // Format from API response
              locationDisplay = currentData.name;
              if (currentData.sys.state) {
                locationDisplay += `, ${currentData.sys.state}`;
              }
              locationDisplay += `, ${currentData.sys.country}`;
            }

            const weatherData = {
              location: locationDisplay,
              temperature: Math.round(currentData.main.temp),
              condition: currentData.weather[0].main,
              humidity: currentData.main.humidity,
              windSpeed: Math.round(currentData.wind?.speed || 0),
              feelsLike: Math.round(currentData.main.feels_like),
              forecast: todaysForecast,
            };

            displayWeather(weatherData);

            // Save the new location
            savedLocation = location;
            try {
              localStorage.setItem("weatherWardrobeLocation", savedLocation);
            } catch (e) {
              console.log("Cannot save location");
            }
            updateUI();
          } else {
            showError(
              currentData.error ||
                'Location not found. Please try again with a different format (e.g., "New York, NY" or "10001").',
            );
          }
        } catch (err) {
          console.log("Secure API call failed, using demo data:", err);

          // Demo weather data with forecast
          // Simple demo location handling
          let demoLocationName = location;

          // If it's a zip code, use demo city name
          if (location.match(/^\d{5}(-\d{4})?$/)) {
            demoLocationName = "Demo City";
          }

          // Generate demo weather in appropriate units
          // Update currentUnits based on user preference for demo data
          if (userProfile.unitPreference !== 'auto') {
            currentUnits = userProfile.unitPreference;
          }

          let demoTemp, demoFeelsLike, demoHigh, demoLow, demoWind;
          console.log("Demo data using units:", currentUnits, "based on preference:", userProfile.unitPreference);
          if (currentUnits === 'metric') {
            demoTemp = Math.floor(Math.random() * 30) + 0; // 0-30¬∞C
            demoFeelsLike = Math.floor(Math.random() * 30) + 0;
            demoHigh = Math.floor(Math.random() * 15) + 20; // 20-35¬∞C
            demoLow = Math.floor(Math.random() * 15) + 5; // 5-20¬∞C
            demoWind = Math.floor(Math.random() * 25) + 5; // 5-30 km/h
          } else {
            demoTemp = Math.floor(Math.random() * 50) + 30; // 30-80¬∞F
            demoFeelsLike = Math.floor(Math.random() * 50) + 30;
            demoHigh = Math.floor(Math.random() * 20) + 70; // 70-90¬∞F
            demoLow = Math.floor(Math.random() * 20) + 40; // 40-60¬∞F
            demoWind = Math.floor(Math.random() * 15) + 2; // 2-17 mph
          }

          const demoWeather = {
            location: demoLocationName,
            temperature: demoTemp,
            condition: ["Clear", "Clouds", "Rain", "Snow"][
              Math.floor(Math.random() * 4)
            ],
            humidity: Math.floor(Math.random() * 40) + 40,
            windSpeed: demoWind,
            feelsLike: demoFeelsLike,
            forecast: {
              high: demoHigh,
              low: demoLow,
              afternoon: ["Sunny", "Cloudy", "Light Rain"][
                Math.floor(Math.random() * 3)
              ],
              evening: ["Clear", "Partly Cloudy", "Overcast"][
                Math.floor(Math.random() * 3)
              ],
              alerts: [`Demo forecast data - units: ${currentUnits}`],
            },
          };

          displayWeather(demoWeather);

          // Save location even for demo
          savedLocation = location;
          try {
            localStorage.setItem("weatherWardrobeLocation", savedLocation);
          } catch (e) {
            console.log("Cannot save location");
          }
          updateUI();
        } finally {
          // Reset button
          if (button) {
            button.textContent =
              button.id === "getWeatherBtn"
                ? "Get Clothing Advice"
                : "Get Today's Clothing Advice";
            button.disabled = false;
          }
        }
      }

      function displayWeather(weather) {
        console.log("üå°Ô∏è displayWeather called");
        console.log("üå°Ô∏è userProfile.unitPreference:", userProfile.unitPreference);
        console.log("üå°Ô∏è currentUnits:", currentUnits);
        console.log("üå°Ô∏è Original weather data:", weather);

        // Convert values if needed based on user preference
        let displayTemp = weather.temperature;
        let displayFeelsLike = weather.feelsLike;
        let displayWindSpeed = weather.windSpeed;
        let displayForecast = weather.forecast;

        // Check for impossible temperature values (indicates API returned wrong units)
        const impossibleMetric = userProfile.unitPreference === 'metric' && displayTemp > 50; // 50¬∞C+ is impossible weather
        const impossibleImperial = userProfile.unitPreference === 'imperial' && displayTemp < 10; // Below 10¬∞F is very rare

        console.log("üå°Ô∏è Temperature check - value:", displayTemp);
        console.log("üå°Ô∏è Impossible metric (>50¬∞C)?", impossibleMetric);
        console.log("üå°Ô∏è Impossible imperial (<10¬∞F)?", impossibleImperial);

        // If user wants metric but we got imperial values, OR if temp values seem wrong, convert them
        if ((userProfile.unitPreference === 'metric' && currentUnits === 'imperial') || impossibleMetric) {
          if (impossibleMetric) {
            console.log("üîÑ FORCED conversion - API returned Fahrenheit values despite requesting Celsius!");
          } else {
            console.log("üîÑ Converting imperial to metric for display");
          }
          console.log("üîÑ Before conversion - temp:", displayTemp, "feelsLike:", displayFeelsLike, "wind:", displayWindSpeed);

          displayTemp = fahrenheitToCelsius(weather.temperature);
          displayFeelsLike = fahrenheitToCelsius(weather.feelsLike);
          displayWindSpeed = mphToKmh(weather.windSpeed);

          console.log("üîÑ After conversion - temp:", displayTemp, "feelsLike:", displayFeelsLike, "wind:", displayWindSpeed);

          if (displayForecast) {
            console.log("üîÑ Converting forecast - original high:", displayForecast.high, "low:", displayForecast.low);
            displayForecast = {
              ...displayForecast,
              high: fahrenheitToCelsius(displayForecast.high),
              low: fahrenheitToCelsius(displayForecast.low)
            };
            console.log("üîÑ Converted forecast - high:", displayForecast.high, "low:", displayForecast.low);
          }
          currentUnits = 'metric'; // Update for formatting
        }
        // If user wants imperial but we got metric values, OR if temp values seem wrong, convert them
        else if ((userProfile.unitPreference === 'imperial' && currentUnits === 'metric') || impossibleImperial) {
          console.log("üîÑ Converting metric to imperial for display");
          displayTemp = celsiusToFahrenheit(weather.temperature);
          displayFeelsLike = celsiusToFahrenheit(weather.feelsLike);
          displayWindSpeed = displayWindSpeed / 1.60934; // km/h to mph

          if (displayForecast) {
            displayForecast = {
              ...displayForecast,
              high: celsiusToFahrenheit(displayForecast.high),
              low: celsiusToFahrenheit(displayForecast.low)
            };
          }
          currentUnits = 'imperial'; // Update for formatting
        } else {
          console.log("üîÑ No conversion needed - userPref:", userProfile.unitPreference, "currentUnits:", currentUnits);
        }

        // Update weather info with converted values
        document.getElementById("weatherLocation").textContent =
          weather.location;
        document.getElementById("weatherTemp").textContent =
          formatTemperature(displayTemp);
        document.getElementById("weatherCondition").textContent =
          weather.condition;
        document.getElementById("feelsLike").textContent =
          formatTemperature(displayFeelsLike);
        document.getElementById("humidity").textContent =
          weather.humidity + "%";
        document.getElementById("windSpeed").textContent =
          formatWindSpeed(displayWindSpeed);

        // Update weather icon
        const iconContainer = document.getElementById("weatherIcon");
        iconContainer.innerHTML = getWeatherIcon(weather.condition);

        // Update today's forecast if available
        const forecastContainer = document.getElementById("todaysForecast");
        if (displayForecast) {
          console.log("Displaying forecast:", displayForecast); // Debug log
          let forecastHTML = `
                    <div class="bg-blue-50 rounded-xl p-4 mt-4">
                        <h4 class="font-semibold text-blue-800 mb-2">üìÖ Today's Forecast</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-3">
                            <div class="text-center">
                                <p class="text-blue-600">High</p>
                                <p class="font-bold text-blue-800">${formatTemperature(displayForecast.high)}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-blue-600">Low</p>
                                <p class="font-bold text-blue-800">${formatTemperature(displayForecast.low)}</p>
                            </div>
                        </div>
                `;

          if (displayForecast.alerts && displayForecast.alerts.length > 0) {
            forecastHTML += '<div class="space-y-1">';
            displayForecast.alerts.forEach((alert) => {
              forecastHTML += `<p class="text-blue-700 text-xs">‚ö†Ô∏è ${alert}</p>`;
            });
            forecastHTML += "</div>";
          }

          forecastHTML += "</div>";
          forecastContainer.innerHTML = forecastHTML;
          forecastContainer.classList.remove("hidden");
        } else {
          console.log("No forecast data to display"); // Debug log
          forecastContainer.classList.add("hidden");
        }

        // Update clothing advice with detailed categorized recommendations using converted values
        const advice = getClothingRecommendation(
          displayTemp,
          weather.condition,
          displayForecast,
        );

        // The new system populates individual categories automatically

        // Show personalized note if applicable
        if (userProfile.hasLearned) {
          document
            .getElementById("personalizedNote")
            .classList.remove("hidden");
        }

        // Show results
        document.getElementById("weatherResults").classList.remove("hidden");
      }

      function getWeatherIcon(condition) {
        const lowerCondition = condition.toLowerCase();
        if (
          lowerCondition.includes("rain") ||
          lowerCondition.includes("drizzle")
        ) {
          return `<svg class="weather-icon text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M8 19v2m8-2v2m-4-3v2m-4-5v2"/>
                </svg>`;
        } else if (lowerCondition.includes("cloud")) {
          return `<svg class="weather-icon text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                </svg>`;
        } else {
          return `<svg class="weather-icon text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>`;
        }
      }

      function getClothingRecommendation(temp, condition, forecast) {
        const lowerCondition = condition.toLowerCase();
        let baseTemp = temp;

        // Adjust temperature based on user preferences
        if (userProfile.temperaturePreference === "runs-hot") {
          baseTemp += 10;
        } else if (userProfile.temperaturePreference === "runs-cold") {
          baseTemp -= 10;
        }

        // Adjust for activity level
        if (userProfile.activityLevel === "active") {
          baseTemp += 5; // Active people get warmer
        } else if (userProfile.activityLevel === "sedentary") {
          baseTemp -= 3; // Sedentary people might feel cooler
        }

        // Get detailed recommendations by category
        const recommendations = getDetailedClothingRecommendations(
          baseTemp,
          lowerCondition,
          forecast,
        );

        // Update each category in the UI
        const topEl = document.getElementById("topRecommendation");
        const bottomEl = document.getElementById("bottomRecommendation");
        const footwearEl = document.getElementById("footwearRecommendation");
        const accessoriesEl = document.getElementById(
          "accessoriesRecommendation",
        );
        const alertDiv = document.getElementById("weatherAlerts");
        const alertText = document.getElementById("weatherAlertText");

        console.log("Elements found:", {
          topEl: !!topEl,
          bottomEl: !!bottomEl,
          footwearEl: !!footwearEl,
          accessoriesEl: !!accessoriesEl,
          alertDiv: !!alertDiv,
          alertText: !!alertText,
        });

        if (topEl) topEl.textContent = recommendations.top;
        if (bottomEl) bottomEl.textContent = recommendations.bottom;
        if (footwearEl) footwearEl.textContent = recommendations.footwear;
        if (accessoriesEl)
          accessoriesEl.textContent = recommendations.accessories;

        // Handle weather alerts
        if (recommendations.alerts && recommendations.alerts.length > 0) {
          alertText.textContent = recommendations.alerts.join(" ");
          alertDiv.classList.remove("hidden");
        } else {
          alertDiv.classList.add("hidden");
        }

        // Return a summary for backward compatibility
        return `${recommendations.top} ${recommendations.bottom} ${recommendations.footwear}`;
      }

      function showError(message) {
        document.getElementById("errorText").textContent = message;
        document.getElementById("errorDiv").classList.remove("hidden");
      }

      function hideError() {
        document.getElementById("errorDiv").classList.add("hidden");
      }

      // Location autocomplete functionality
      let searchTimeout;
      let selectedLocation = null;
      let recentLocations = [];

      function handleLocationInput(value) {
        clearTimeout(searchTimeout);
        const trimmedValue = value.trim();

        if (trimmedValue.length === 0) {
          hideLocationSuggestions();
          return;
        }

        // If it looks like a zip code, don't search for suggestions
        if (/^\d{1,5}$/.test(trimmedValue)) {
          hideLocationSuggestions();
          return;
        }

        // Debounce search requests
        searchTimeout = setTimeout(() => {
          if (trimmedValue.length >= 2) {
            searchLocations(trimmedValue);
          }
        }, 300);
      }

      async function searchLocations(query) {
        const suggestionsList = document.getElementById("suggestionsList");
        const loadingDiv = document.getElementById("loadingSuggestion");
        const suggestionsContainer = document.getElementById(
          "locationSuggestions",
        );

        // Show loading state
        suggestionsList.innerHTML = "";
        loadingDiv.classList.remove("hidden");
        suggestionsContainer.classList.remove("hidden");

        console.log("Searching locations for query:", query);

        try {
          // Use OpenWeather Geocoding API with more results
          const apiUrl = `/api/geocoding?q=${encodeURIComponent(query)}&limit=10`;
          console.log("Calling geocoding API:", apiUrl);

          const response = await fetch(apiUrl);
          console.log("Geocoding API response status:", response.status);
          console.log("Geocoding API response headers:", response.headers);

          if (response.ok) {
            const locations = await response.json();
            console.log("Geocoding API returned locations:", locations);
            console.log("Number of locations found:", locations.length);

            if (locations && locations.length > 0) {
              displayLocationSuggestions(locations);
            } else {
              console.log("API returned empty results");
              suggestionsList.innerHTML =
                '<div class="px-4 py-2 text-sm text-gray-500">No locations found for this search</div>';
            }
          } else if (response.status === 404) {
            console.log(
              "Geocoding API not deployed - using zip code only mode",
            );
            suggestionsList.innerHTML =
              '<div class="px-4 py-2 text-sm text-gray-500">City search temporarily unavailable - try zip codes</div>';
          } else {
            const errorData = await response
              .json()
              .catch(() => ({ error: "Unknown error" }));
            console.log("Geocoding API error:", errorData);
            suggestionsList.innerHTML = `<div class="px-4 py-2 text-sm text-gray-500">Search service error: ${errorData.error || "Unknown error"}</div>`;
          }
        } catch (error) {
          console.log("Geocoding API network error:", error);
          suggestionsList.innerHTML = `<div class="px-4 py-2 text-sm text-gray-500">Network error: ${error.message}</div>`;
        }

        loadingDiv.classList.add("hidden");
      }

      function displayLocationSuggestions(locations) {
        const suggestionsList = document.getElementById("suggestionsList");
        const suggestionsContainer = document.getElementById(
          "locationSuggestions",
        );

        suggestionsList.innerHTML = "";

        if (locations.length === 0) {
          suggestionsList.innerHTML =
            '<div class="px-4 py-2 text-sm text-gray-500">No locations found</div>';
          return;
        }

        locations.forEach((location) => {
          const displayName = formatLocationName(location);
          const suggestionItem = document.createElement("div");
          suggestionItem.className = "suggestion-item text-sm";
          suggestionItem.innerHTML = `
            <div class="font-medium text-gray-900">${displayName}</div>
            <div class="text-xs text-gray-500">${location.country || ""}</div>
          `;

          suggestionItem.onclick = () => selectLocation(location, displayName);
          suggestionsList.appendChild(suggestionItem);
        });

        suggestionsContainer.classList.remove("hidden");
      }

      // Demo suggestions function removed - using OpenWeather Geocoding API exclusively
      function displayDemoSuggestions(query) {
        // This function is deprecated - OpenWeather API should be used instead
        const demoSuggestions = [
          {
            name: "New York",
            state: "NY",
            country: "US",
            lat: 40.7128,
            lon: -74.006,
          },
          {
            name: "Los Angeles",
            state: "CA",
            country: "US",
            lat: 34.0522,
            lon: -118.2437,
          },
          {
            name: "Chicago",
            state: "IL",
            country: "US",
            lat: 41.8781,
            lon: -87.6298,
          },
          {
            name: "Houston",
            state: "TX",
            country: "US",
            lat: 29.7604,
            lon: -95.3698,
          },
          {
            name: "Phoenix",
            state: "AZ",
            country: "US",
            lat: 33.4484,
            lon: -112.074,
          },
          {
            name: "Philadelphia",
            state: "PA",
            country: "US",
            lat: 39.9526,
            lon: -75.1652,
          },
          {
            name: "San Antonio",
            state: "TX",
            country: "US",
            lat: 29.4241,
            lon: -98.4936,
          },
          {
            name: "San Diego",
            state: "CA",
            country: "US",
            lat: 32.7157,
            lon: -117.1611,
          },
          {
            name: "Dallas",
            state: "TX",
            country: "US",
            lat: 32.7767,
            lon: -96.797,
          },
          {
            name: "San Jose",
            state: "CA",
            country: "US",
            lat: 37.3382,
            lon: -121.8863,
          },
          {
            name: "Austin",
            state: "TX",
            country: "US",
            lat: 30.2672,
            lon: -97.7431,
          },
          {
            name: "Jacksonville",
            state: "FL",
            country: "US",
            lat: 30.3322,
            lon: -81.6557,
          },
          {
            name: "Fort Worth",
            state: "TX",
            country: "US",
            lat: 32.7555,
            lon: -97.3308,
          },
          {
            name: "Columbus",
            state: "OH",
            country: "US",
            lat: 39.9612,
            lon: -82.9988,
          },
          {
            name: "Charlotte",
            state: "NC",
            country: "US",
            lat: 35.2271,
            lon: -80.8431,
          },
          {
            name: "San Francisco",
            state: "CA",
            country: "US",
            lat: 37.7749,
            lon: -122.4194,
          },
          {
            name: "Indianapolis",
            state: "IN",
            country: "US",
            lat: 39.7684,
            lon: -86.1581,
          },
          {
            name: "Seattle",
            state: "WA",
            country: "US",
            lat: 47.6062,
            lon: -122.3321,
          },
          {
            name: "Denver",
            state: "CO",
            country: "US",
            lat: 39.7392,
            lon: -104.9903,
          },
          {
            name: "Boston",
            state: "MA",
            country: "US",
            lat: 42.3601,
            lon: -71.0589,
          },
          {
            name: "El Paso",
            state: "TX",
            country: "US",
            lat: 31.7619,
            lon: -106.485,
          },
          {
            name: "Detroit",
            state: "MI",
            country: "US",
            lat: 42.3314,
            lon: -83.0458,
          },
          {
            name: "Nashville",
            state: "TN",
            country: "US",
            lat: 36.1627,
            lon: -86.7816,
          },
          {
            name: "Portland",
            state: "OR",
            country: "US",
            lat: 45.5152,
            lon: -122.6784,
          },
          {
            name: "Las Vegas",
            state: "NV",
            country: "US",
            lat: 36.1699,
            lon: -115.1398,
          },
          {
            name: "Oklahoma City",
            state: "OK",
            country: "US",
            lat: 35.4676,
            lon: -97.5164,
          },
          {
            name: "Memphis",
            state: "TN",
            country: "US",
            lat: 35.1495,
            lon: -90.049,
          },
          {
            name: "Louisville",
            state: "KY",
            country: "US",
            lat: 38.2527,
            lon: -85.7585,
          },
          {
            name: "Baltimore",
            state: "MD",
            country: "US",
            lat: 39.2904,
            lon: -76.6122,
          },
          {
            name: "Milwaukee",
            state: "WI",
            country: "US",
            lat: 43.0389,
            lon: -87.9065,
          },
          {
            name: "Albuquerque",
            state: "NM",
            country: "US",
            lat: 35.0844,
            lon: -106.6504,
          },
          {
            name: "Tucson",
            state: "AZ",
            country: "US",
            lat: 32.2226,
            lon: -110.9747,
          },
          {
            name: "Fresno",
            state: "CA",
            country: "US",
            lat: 36.7378,
            lon: -119.7871,
          },
          {
            name: "Sacramento",
            state: "CA",
            country: "US",
            lat: 38.5816,
            lon: -121.4944,
          },
          {
            name: "Kansas City",
            state: "MO",
            country: "US",
            lat: 39.0997,
            lon: -94.5786,
          },
          {
            name: "Mesa",
            state: "AZ",
            country: "US",
            lat: 33.4152,
            lon: -111.8315,
          },
          {
            name: "Atlanta",
            state: "GA",
            country: "US",
            lat: 33.749,
            lon: -84.388,
          },
          {
            name: "Colorado Springs",
            state: "CO",
            country: "US",
            lat: 38.8339,
            lon: -104.8214,
          },
          {
            name: "Omaha",
            state: "NE",
            country: "US",
            lat: 41.2565,
            lon: -95.9345,
          },
          {
            name: "Raleigh",
            state: "NC",
            country: "US",
            lat: 35.7796,
            lon: -78.6382,
          },
          {
            name: "Miami",
            state: "FL",
            country: "US",
            lat: 25.7617,
            lon: -80.1918,
          },
          {
            name: "Virginia Beach",
            state: "VA",
            country: "US",
            lat: 36.8529,
            lon: -75.978,
          },
          {
            name: "Oakland",
            state: "CA",
            country: "US",
            lat: 37.8044,
            lon: -122.2711,
          },
          {
            name: "Minneapolis",
            state: "MN",
            country: "US",
            lat: 44.9778,
            lon: -93.265,
          },
          {
            name: "Tulsa",
            state: "OK",
            country: "US",
            lat: 36.154,
            lon: -95.9928,
          },
          {
            name: "Arlington",
            state: "TX",
            country: "US",
            lat: 32.7357,
            lon: -97.1081,
          },
          {
            name: "New Orleans",
            state: "LA",
            country: "US",
            lat: 29.9511,
            lon: -90.0715,
          },
          {
            name: "Wichita",
            state: "KS",
            country: "US",
            lat: 37.6872,
            lon: -97.3301,
          },
          {
            name: "Cleveland",
            state: "OH",
            country: "US",
            lat: 41.4993,
            lon: -81.6944,
          },
          {
            name: "Tampa",
            state: "FL",
            country: "US",
            lat: 27.9506,
            lon: -82.4572,
          },
          {
            name: "Riverside",
            state: "CA",
            country: "US",
            lat: 33.9533,
            lon: -117.3962,
          },
          {
            name: "Riverside",
            state: "NJ",
            country: "US",
            lat: 40.0368,
            lon: -74.9632,
          },
          {
            name: "Daytona Beach",
            state: "FL",
            country: "US",
            lat: 29.2108,
            lon: -81.0228,
          },
          {
            name: "Dayton",
            state: "OH",
            country: "US",
            lat: 39.7589,
            lon: -84.1916,
          },
          {
            name: "Danbury",
            state: "CT",
            country: "US",
            lat: 41.3948,
            lon: -73.454,
          },
          {
            name: "Danville",
            state: "VA",
            country: "US",
            lat: 36.586,
            lon: -79.395,
          },
          {
            name: "Daly City",
            state: "CA",
            country: "US",
            lat: 37.7058,
            lon: -122.4619,
          },
        ];

        // Filter for any partial match in city name
        const filtered = demoSuggestions
          .filter((city) => {
            const cityName = city.name.toLowerCase();
            const queryLower = query.toLowerCase();
            return (
              cityName.startsWith(queryLower) || cityName.includes(queryLower)
            );
          })
          .sort((a, b) => {
            // Prioritize cities that start with the query
            const aStarts = a.name
              .toLowerCase()
              .startsWith(query.toLowerCase());
            const bStarts = b.name
              .toLowerCase()
              .startsWith(query.toLowerCase());
            if (aStarts && !bStarts) return -1;
            if (!aStarts && bStarts) return 1;
            return a.name.localeCompare(b.name);
          })
          .slice(0, 10); // Show more results

        console.log(
          `Demo suggestions for "${query}":`,
          filtered.map((c) => c.name),
        );
        displayLocationSuggestions(filtered);
      }

      function formatLocationName(location) {
        if (location.state) {
          return `${location.name}, ${location.state}`;
        } else if (location.country) {
          return `${location.name}, ${location.country}`;
        }
        return location.name;
      }

      function selectLocation(location, displayName) {
        selectedLocation = location;
        document.getElementById("locationInput").value = displayName;
        hideLocationSuggestions();

        // Add to recent locations
        addToRecentLocations(location, displayName);
      }

      function addToRecentLocations(location, displayName) {
        // Remove if already exists
        recentLocations = recentLocations.filter(
          (item) => item.displayName !== displayName,
        );

        // Add to front
        recentLocations.unshift({ location, displayName });

        // Keep only last 5
        recentLocations = recentLocations.slice(0, 5);

        // Save to localStorage
        try {
          localStorage.setItem(
            "weatherWardrobeRecentLocations",
            JSON.stringify(recentLocations),
          );
        } catch (e) {
          console.log("Cannot save recent locations");
        }
      }

      function loadRecentLocations() {
        try {
          const saved = localStorage.getItem("weatherWardrobeRecentLocations");
          if (saved) {
            recentLocations = JSON.parse(saved);
          }
        } catch (e) {
          console.log("Cannot load recent locations");
        }
      }

      function showRecentSuggestions() {
        if (
          recentLocations.length > 0 &&
          document.getElementById("locationInput").value.trim() === ""
        ) {
          const suggestionsList = document.getElementById("suggestionsList");
          const suggestionsContainer = document.getElementById(
            "locationSuggestions",
          );

          suggestionsList.innerHTML =
            '<div class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wide">Recent Locations</div>';

          recentLocations.forEach((item) => {
            const suggestionItem = document.createElement("div");
            suggestionItem.className = "suggestion-item text-sm";
            suggestionItem.innerHTML = `
              <div class="font-medium text-gray-900">${item.displayName}</div>
              <div class="text-xs text-gray-500">Recent</div>
            `;

            suggestionItem.onclick = () =>
              selectLocation(item.location, item.displayName);
            suggestionsList.appendChild(suggestionItem);
          });

          suggestionsContainer.classList.remove("hidden");
        }
      }

      function hideLocationSuggestions() {
        document.getElementById("locationSuggestions").classList.add("hidden");
      }

      function getDetailedClothingRecommendations(
        baseTemp,
        condition,
        forecast,
      ) {
        const style = userProfile.stylePreference;
        const isRainy =
          condition.includes("rain") || condition.includes("drizzle");
        const isSnowy = condition.includes("snow");
        const isWindy = condition.includes("wind");

        let recommendations = {
          top: "",
          bottom: "",
          footwear: "",
          accessories: "",
          alerts: [],
        };

        // Normalize temperature to Fahrenheit for consistent thresholds
        // If we're using metric, the API returns Celsius, so convert to Fahrenheit for clothing logic
        let tempForClothing = baseTemp;
        if (currentUnits === 'metric') {
          tempForClothing = celsiusToFahrenheit(baseTemp);
        }

        // Upper Body Recommendations (using Fahrenheit thresholds)
        if (tempForClothing >= 80) {
          if (style === "professional") {
            recommendations.top =
              "Lightweight button-down, breathable blouse, or linen shirt";
          } else if (style === "sporty") {
            recommendations.top =
              "Moisture-wicking tank top or performance t-shirt";
          } else if (style === "fashion") {
            recommendations.top =
              "Stylish crop top, trendy tank, or flowy blouse";
          } else {
            recommendations.top =
              "Light cotton t-shirt, tank top, or sleeveless top";
          }
        } else if (tempForClothing >= 70) {
          if (style === "professional") {
            recommendations.top =
              "Cotton button-down, polo shirt, or lightweight blouse";
          } else if (style === "sporty") {
            recommendations.top =
              "Athletic t-shirt, performance polo, or workout top";
          } else if (style === "fashion") {
            recommendations.top =
              "Trendy t-shirt, fashion top, or lightweight cardigan";
          } else {
            recommendations.top =
              "Comfortable t-shirt, casual button-down, or light sweater";
          }
        } else if (tempForClothing >= 60) {
          if (style === "professional") {
            recommendations.top =
              "Long-sleeve shirt with light blazer or cardigan";
          } else if (style === "sporty") {
            recommendations.top =
              "Long-sleeve athletic shirt or lightweight hoodie";
          } else if (style === "fashion") {
            recommendations.top =
              "Stylish sweater, fashion cardigan, or layered look";
          } else {
            recommendations.top =
              "Long-sleeve shirt, light sweater, or thin hoodie";
          }
        } else if (tempForClothing >= 50) {
          if (style === "professional") {
            recommendations.top =
              "Wool sweater, thick blazer, or professional cardigan";
          } else if (style === "sporty") {
            recommendations.top =
              "Fleece jacket, thick hoodie, or athletic sweatshirt";
          } else if (style === "fashion") {
            recommendations.top =
              "Trendy sweater, oversized cardigan, or stylish jacket";
          } else {
            recommendations.top =
              "Medium-weight sweater, hoodie, or casual jacket";
          }
        } else if (tempForClothing >= 40) {
          recommendations.top = "Warm sweater or fleece with insulating layers";
        } else if (tempForClothing >= 30) {
          recommendations.top =
            "Heavy sweater, thermal base layer, and warm coat";
        } else {
          recommendations.top =
            "Multiple layers: thermal underwear, heavy sweater, winter coat";
        }

        // Lower Body Recommendations
        if (baseTemp >= 80) {
          if (style === "professional") {
            recommendations.bottom =
              "Lightweight dress pants, knee-length skirt, or professional shorts";
          } else if (style === "sporty") {
            recommendations.bottom =
              "Athletic shorts, performance leggings, or gym wear";
          } else if (style === "fashion") {
            recommendations.bottom =
              "High-waisted shorts, mini skirt, or trendy capris";
          } else {
            recommendations.bottom =
              "Shorts, lightweight pants, or summer dress";
          }
        } else if (tempForClothing >= 70) {
          if (style === "professional") {
            recommendations.bottom =
              "Dress pants, midi skirt, or tailored trousers";
          } else if (style === "sporty") {
            recommendations.bottom = "Athletic pants, leggings, or joggers";
          } else if (style === "fashion") {
            recommendations.bottom =
              "Jeans, fashionable pants, or stylish skirt";
          } else {
            recommendations.bottom =
              "Jeans, casual pants, or comfortable skirt";
          }
        } else if (tempForClothing >= 50) {
          if (style === "professional") {
            recommendations.bottom =
              "Wool pants, warm skirt with tights, or dress slacks";
          } else if (style === "sporty") {
            recommendations.bottom =
              "Thermal leggings, warm athletic pants, or fleece-lined joggers";
          } else {
            recommendations.bottom = "Jeans, warm pants, or thick leggings";
          }
        } else if (tempForClothing >= 30) {
          recommendations.bottom =
            "Insulated pants, thermal leggings, or winter trousers";
        } else {
          recommendations.bottom =
            "Thermal underwear with heavy pants or insulated winter gear";
        }

        // Footwear Recommendations
        if (baseTemp >= 80) {
          if (style === "professional") {
            recommendations.footwear =
              "Breathable dress shoes, professional sandals, or loafers";
          } else if (style === "sporty") {
            recommendations.footwear =
              "Athletic shoes, running sandals, or sport slides";
          } else if (style === "fashion") {
            recommendations.footwear =
              "Stylish sandals, fashion sneakers, or trendy flats";
          } else {
            recommendations.footwear =
              "Sandals, flip-flops, or breathable sneakers";
          }
        } else if (tempForClothing >= 70) {
          if (style === "professional") {
            recommendations.footwear =
              "Dress shoes, professional flats, or loafers";
          } else if (style === "sporty") {
            recommendations.footwear =
              "Sneakers, athletic shoes, or casual trainers";
          } else {
            recommendations.footwear =
              "Comfortable shoes, casual sneakers, or flats";
          }
        } else if (tempForClothing >= 50) {
          if (style === "professional") {
            recommendations.footwear =
              "Closed-toe dress shoes or professional ankle boots";
          } else {
            recommendations.footwear =
              "Sneakers, boots, or warm closed-toe shoes";
          }
        } else if (tempForClothing >= 30) {
          recommendations.footwear =
            "Insulated boots or warm winter shoes with good traction";
        } else {
          recommendations.footwear =
            "Waterproof winter boots with thermal insulation";
        }

        // Accessories Recommendations
        if (baseTemp >= 80) {
          recommendations.accessories = "Sunglasses, sun hat, and sunscreen";
        } else if (tempForClothing >= 70) {
          recommendations.accessories =
            "Light accessories, sunglasses if sunny";
        } else if (tempForClothing >= 60) {
          recommendations.accessories = "Light scarf or jacket you can remove";
        } else if (tempForClothing >= 50) {
          recommendations.accessories = "Scarf, light gloves, or warm hat";
        } else if (tempForClothing >= 40) {
          recommendations.accessories = "Warm scarf, gloves, and beanie or hat";
        } else if (tempForClothing >= 30) {
          recommendations.accessories =
            "Insulated gloves, warm hat, thick scarf";
        } else {
          recommendations.accessories =
            "Full winter accessories: thermal gloves, warm hat, thick scarf";
        }

        // Weather-specific alerts and adjustments
        if (isRainy) {
          recommendations.alerts.push(
            "Rain expected - bring umbrella and waterproof footwear!",
          );
          if (
            recommendations.footwear.includes("sandals") ||
            recommendations.footwear.includes("flats")
          ) {
            recommendations.footwear = "Water-resistant shoes or rain boots";
          }
        }

        if (isSnowy) {
          recommendations.alerts.push(
            "Snow conditions - wear waterproof boots with good traction!",
          );
          recommendations.footwear =
            "Waterproof winter boots with anti-slip soles";
        }

        if (isWindy) {
          recommendations.alerts.push(
            "Windy conditions - secure loose clothing and accessories!",
          );
        }

        // Work environment adjustments
        if (userProfile.workEnvironment === "outdoor") {
          recommendations.alerts.push(
            "Working outdoors - choose weather-resistant materials",
          );
        }

        return recommendations;
      }

      // Allow Enter key to search - with proper event handling
      document
        .getElementById("locationInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            e.preventDefault(); // Prevent form submission/page refresh
            e.stopPropagation(); // Stop event bubbling
            getWeather();
          }
        });

      // Also prevent any form submission if the input is somehow in a form
      document
        .getElementById("locationInput")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            getWeather();
          }
        });
    </script>
    <!-- Secure API deployment -->
  </body>
</html>
