<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather Wardrobe - Smart Clothing for Any Weather</title>
    <meta
      name="description"
      content="Get personalized clothing recommendations based on current weather conditions"
    />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3B82F6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Weather Wardrobe" />

    <!-- Updated Favicon -->
    <link rel="icon" type="image/png" href="assets/weather_wardrobe_icon.png" />
    <link rel="apple-touch-icon" href="assets/weather_wardrobe_icon.png" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      .weather-icon {
        width: 48px;
        height: 48px;
      }
      .hidden {
        display: none;
      }
      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      .spinner-sm {
        width: 12px;
        height: 12px;
        border: 2px solid rgba(100, 100, 100, 0.3);
        border-top: 2px solid #666;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .suggestion-item {
        padding: 8px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
      }
      .suggestion-item:hover {
        background-color: #f8fafc;
      }
      .suggestion-item:last-child {
        border-bottom: none;
      }
      .app-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-blue-400 via-blue-500 to-blue-600 p-4"
  >
    <div class="max-w-md mx-auto">
      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
        <!-- Header -->
        <div
          class="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white relative overflow-hidden"
        >
          <div class="flex items-center justify-between relative">
            <div class="flex items-center space-x-3">
              <!-- Updated App Icon -->
              <div class="relative">
                <img
                  src="assets/weather_wardrobe_icon.png"
                  alt="Weather Wardrobe"
                  class="app-icon"
                />
              </div>

              <div>
                <h1 class="text-2xl font-bold tracking-wide">
                  Weather Wardrobe
                </h1>
                <p class="text-blue-100 text-sm" id="welcomeText">
                  Smart clothing for any weather
                </p>
              </div>
            </div>

            <button
              onclick="toggleProfile()"
              class="p-3 bg-white bg-opacity-20 rounded-xl hover:bg-opacity-30 transition-all duration-200 backdrop-blur-sm"
              id="profileBtn"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
            </button>
          </div>
        </div>
        <!-- Profile Setup -->
        <div
          id="profileSection"
          class="hidden p-6 border-b border-gray-200 bg-gray-50"
        >
          <h3 class="text-lg font-semibold mb-4">
            Personalize Your Experience
          </h3>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Your Name</label
              >
              <input
                type="text"
                id="userName"
                placeholder="Enter your name"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Unit Preference</label
              >
              <div class="grid grid-cols-3 gap-2" id="unitPrefs">
                <button
                  onclick="setUnitPref('auto')"
                  class="unit-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700"
                  data-value="auto"
                >
                  <div class="text-lg font-bold">Auto</div>
                  <div class="text-gray-500 text-xs">Based on location</div>
                </button>
                <button
                  onclick="setUnitPref('imperial')"
                  class="unit-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="imperial"
                >
                  <div class="text-lg font-bold">°F, mph</div>
                  <div class="text-gray-500 text-xs">Imperial</div>
                </button>
                <button
                  onclick="setUnitPref('metric')"
                  class="unit-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="metric"
                >
                  <div class="text-lg font-bold">°C, km/h</div>
                  <div class="text-gray-500 text-xs">Metric</div>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Temperature Preference</label
              >
              <div class="grid grid-cols-3 gap-2" id="tempPrefs">
                <button
                  onclick="setTempPref('runs-cold')"
                  class="temp-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="runs-cold"
                >
                  <div class="font-medium">I Run Cold</div>
                  <div class="text-gray-500">Need warmer clothes</div>
                </button>
                <button
                  onclick="setTempPref('average')"
                  class="temp-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700"
                  data-value="average"
                >
                  <div class="font-medium">Average</div>
                  <div class="text-gray-500">Standard comfort</div>
                </button>
                <button
                  onclick="setTempPref('runs-hot')"
                  class="temp-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="runs-hot"
                >
                  <div class="font-medium">I Run Hot</div>
                  <div class="text-gray-500">Need lighter clothes</div>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Activity Level</label
              >
              <div class="grid grid-cols-3 gap-2" id="activityPrefs">
                <button
                  onclick="setActivityLevel('sedentary')"
                  class="activity-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="sedentary"
                >
                  <div class="font-medium">Sedentary</div>
                  <div class="text-gray-500">Office/desk work</div>
                </button>
                <button
                  onclick="setActivityLevel('moderate')"
                  class="activity-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700"
                  data-value="moderate"
                >
                  <div class="font-medium">Moderate</div>
                  <div class="text-gray-500">Some movement</div>
                </button>
                <button
                  onclick="setActivityLevel('active')"
                  class="activity-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="active"
                >
                  <div class="font-medium">Very Active</div>
                  <div class="text-gray-500">Physical work</div>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Style Preference</label
              >
              <div class="grid grid-cols-2 gap-2" id="stylePrefs">
                <button
                  onclick="setStylePref('casual')"
                  class="style-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700"
                  data-value="casual"
                >
                  <div class="font-medium">Casual</div>
                  <div class="text-gray-500">Comfort focused</div>
                </button>
                <button
                  onclick="setStylePref('professional')"
                  class="style-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="professional"
                >
                  <div class="font-medium">Professional</div>
                  <div class="text-gray-500">Business attire</div>
                </button>
                <button
                  onclick="setStylePref('sporty')"
                  class="style-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="sporty"
                >
                  <div class="font-medium">Athletic</div>
                  <div class="text-gray-500">Active wear</div>
                </button>
                <button
                  onclick="setStylePref('fashion')"
                  class="style-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="fashion"
                >
                  <div class="font-medium">Fashion-Forward</div>
                  <div class="text-gray-500">Trend conscious</div>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Work Environment</label
              >
              <div class="grid grid-cols-2 gap-2" id="workPrefs">
                <button
                  onclick="setWorkEnv('indoor')"
                  class="work-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700"
                  data-value="indoor"
                >
                  <div class="font-medium">Indoor Office</div>
                  <div class="text-gray-500">Climate controlled</div>
                </button>
                <button
                  onclick="setWorkEnv('outdoor')"
                  class="work-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="outdoor"
                >
                  <div class="font-medium">Outdoor Work</div>
                  <div class="text-gray-500">Weather exposed</div>
                </button>
                <button
                  onclick="setWorkEnv('mixed')"
                  class="work-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="mixed"
                >
                  <div class="font-medium">Mixed</div>
                  <div class="text-gray-500">Indoor + outdoor</div>
                </button>
                <button
                  onclick="setWorkEnv('home')"
                  class="work-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300"
                  data-value="home"
                >
                  <div class="font-medium">Work from Home</div>
                  <div class="text-gray-500">Home comfort</div>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Special Considerations</label
              >
              <div class="grid grid-cols-1 gap-2" id="specialPrefs">
                <label
                  class="flex items-center space-x-2 p-2 border rounded-lg hover:bg-gray-50"
                >
                  <input
                    type="checkbox"
                    class="special-checkbox"
                    value="natural-fabrics"
                    onchange="toggleSpecialConsideration('natural-fabrics')"
                  />
                  <span class="text-sm"
                    >Prefer natural fabrics (cotton, wool, linen)</span
                  >
                </label>
                <label
                  class="flex items-center space-x-2 p-2 border rounded-lg hover:bg-gray-50"
                >
                  <input
                    type="checkbox"
                    class="special-checkbox"
                    value="easy-care"
                    onchange="toggleSpecialConsideration('easy-care')"
                  />
                  <span class="text-sm"
                    >Need easy-care/wrinkle-free materials</span
                  >
                </label>
                <label
                  class="flex items-center space-x-2 p-2 border rounded-lg hover:bg-gray-50"
                >
                  <input
                    type="checkbox"
                    class="special-checkbox"
                    value="loose-fit"
                    onchange="toggleSpecialConsideration('loose-fit')"
                  />
                  <span class="text-sm">Prefer loose-fitting clothes</span>
                </label>
                <label
                  class="flex items-center space-x-2 p-2 border rounded-lg hover:bg-gray-50"
                >
                  <input
                    type="checkbox"
                    class="special-checkbox"
                    value="layers"
                    onchange="toggleSpecialConsideration('layers')"
                  />
                  <span class="text-sm">Love layering options</span>
                </label>
              </div>
            </div>

            <button
              onclick="saveProfile()"
              class="w-full mt-4 bg-gradient-to-r from-green-600 to-green-700 text-white py-2 px-4 rounded-lg font-medium hover:from-green-700 hover:to-green-800 transition-all"
            >
              Save Preferences
            </button>
          </div>
        </div>
        <!-- Location Input -->
        <div class="p-6">
          <!-- Saved Location Display -->
          <div id="savedLocationDiv" class="hidden mb-6">
            <div
              class="flex items-center justify-between bg-blue-50 rounded-xl p-4 border border-blue-200"
            >
              <div class="flex items-center space-x-3">
                <svg
                  class="w-5 h-5 text-blue-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                <div>
                  <p class="text-sm text-blue-600 font-medium">Your Location</p>
                  <p
                    class="text-blue-800 font-semibold"
                    id="savedLocationText"
                  ></p>
                </div>
              </div>
              <button
                onclick="editLocation()"
                class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                  />
                </svg>
              </button>
            </div>

            <button
              onclick="getWeather()"
              class="w-full mt-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-6 rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
              id="quickWeatherBtn"
            >
              Get Today's Clothing Advice
            </button>
          </div>

          <!-- Location Input Form -->
          <div id="locationInputDiv" class="mb-6">
            <!-- Country Selection First -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-red-500">*</span> Select Your Country First
              </label>
              <select
                id="locationCountrySelect"
                onchange="handleCountrySelection(this.value)"
                class="w-full px-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">Choose your country...</option>
                <option value="US">United States</option>
                <option value="CA">Canada</option>
                <option value="GB">United Kingdom</option>
                <option value="AU">Australia</option>
                <option value="DE">Germany</option>
                <option value="FR">France</option>
                <option value="ES">Spain</option>
                <option value="IT">Italy</option>
                <option value="NL">Netherlands</option>
                <option value="JP">Japan</option>
                <option value="KR">South Korea</option>
                <option value="IN">India</option>
                <option value="BR">Brazil</option>
                <option value="MX">Mexico</option>
                <option value="AR">Argentina</option>
                <option value="ZA">South Africa</option>
                <option value="NG">Nigeria</option>
                <option value="EG">Egypt</option>
                <option value="CN">China</option>
                <option value="TH">Thailand</option>
                <option value="SG">Singapore</option>
                <option value="NZ">New Zealand</option>
                <option value="NO">Norway</option>
                <option value="SE">Sweden</option>
                <option value="DK">Denmark</option>
                <option value="FI">Finland</option>
                <option value="IE">Ireland</option>
                <option value="CH">Switzerland</option>
                <option value="AT">Austria</option>
                <option value="BE">Belgium</option>
                <option value="PT">Portugal</option>
                <option value="GR">Greece</option>
                <option value="PL">Poland</option>
                <option value="CZ">Czech Republic</option>
                <option value="HU">Hungary</option>
                <option value="RO">Romania</option>
                <option value="BG">Bulgaria</option>
                <option value="HR">Croatia</option>
                <option value="SI">Slovenia</option>
                <option value="SK">Slovakia</option>
                <option value="LT">Lithuania</option>
                <option value="LV">Latvia</option>
                <option value="EE">Estonia</option>
                <option value="RU">Russia</option>
                <option value="UA">Ukraine</option>
                <option value="TR">Turkey</option>
                <option value="IL">Israel</option>
                <option value="AE">UAE</option>
                <option value="SA">Saudi Arabia</option>
              </select>
            </div>

            <!-- City Input (Hidden until country selected) -->
            <div class="mb-4" id="cityInputContainer" style="display: none;">
              <label class="block text-sm font-medium text-gray-700 mb-2" id="cityInputLabel">
                <span class="text-red-500">*</span> Enter Your City/Town/Village
              </label>
              <div class="relative">
                <svg
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5 z-10"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                <input
                  type="text"
                  id="locationInput"
                  placeholder="Enter your city, town, or village name"
                  autocomplete="off"
                  class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                  oninput="handleLocationInput(this.value)"
                  onblur="setTimeout(() => hideLocationSuggestions(), 150)"
                  onfocus="showRecentSuggestions()"
                  disabled
                />

                <!-- Autocomplete Dropdown -->
                <div
                  id="locationSuggestions"
                  class="hidden absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"
                >
                  <div id="suggestionsList" class="py-1"></div>
                  <div
                    id="loadingSuggestion"
                    class="hidden px-4 py-2 text-sm text-gray-500 flex items-center"
                  >
                    <div class="spinner-sm mr-2"></div>
                    Searching locations...
                  </div>
                </div>
              </div>
            </div>

            <button
              onclick="getWeather()"
              class="w-full mt-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-6 rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
              id="getWeatherBtn"
              disabled
            >
              <span id="getWeatherBtnText">Select Country & City First</span>
            </button>
          </div>

          <!-- Error Display -->
          <div
            id="errorDiv"
            class="hidden bg-red-50 border border-red-200 rounded-xl p-4 mb-6"
          >
            <p class="text-red-700 text-sm" id="errorText"></p>
          </div>
          <!-- Weather Results -->
          <div id="weatherResults" class="hidden space-y-6">
            <!-- Weather Info -->
            <div
              class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100"
            >
              <div class="flex items-start justify-between mb-6">
                <div class="flex-1">
                  <h2
                    class="text-lg font-medium text-gray-700 mb-1"
                    id="weatherLocation"
                  ></h2>
                  <div class="flex items-baseline space-x-1 mb-2">
                    <span
                      class="text-5xl font-bold text-blue-700"
                      id="weatherTemp"
                    ></span>
                  </div>
                  <p
                    class="text-lg font-medium text-gray-600 capitalize"
                    id="weatherCondition"
                  ></p>
                </div>
                <div class="text-right ml-4" id="weatherIcon"></div>
              </div>

              <div class="grid grid-cols-3 gap-6 pt-4 border-t border-blue-200">
                <div class="text-center">
                  <div class="flex justify-center mb-2">
                    <svg
                      class="w-6 h-6 text-orange-500"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                      />
                    </svg>
                  </div>
                  <p
                    class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1"
                  >
                    Feels like
                  </p>
                  <p class="text-lg font-bold text-gray-800" id="feelsLike"></p>
                </div>
                <div class="text-center">
                  <div class="flex justify-center mb-2">
                    <svg
                      class="w-6 h-6 text-blue-500"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                      />
                    </svg>
                  </div>
                  <p
                    class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1"
                  >
                    Humidity
                  </p>
                  <p class="text-lg font-bold text-gray-800" id="humidity"></p>
                </div>
                <div class="text-center">
                  <div class="flex justify-center mb-2">
                    <svg
                      class="w-6 h-6 text-gray-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  </div>
                  <p
                    class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1"
                  >
                    Wind
                  </p>
                  <p class="text-lg font-bold text-gray-800" id="windSpeed"></p>
                </div>
              </div>

              <!-- Today's Forecast Section -->
              <div id="todaysForecast" class="hidden"></div>
            </div>

            <!-- Clothing Recommendation -->
            <div
              class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6 border border-green-200"
            >
              <div class="flex items-center mb-4">
                <svg
                  class="w-6 h-6 text-green-700 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  />
                </svg>
                <h3 class="text-lg font-semibold text-green-800">
                  What to Wear
                </h3>
              </div>

              <!-- Clothing Categories -->
              <div class="space-y-4 mb-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <!-- Upper Body -->
                  <div class="bg-white bg-opacity-60 rounded-lg p-3">
                    <div class="flex items-center mb-2">
                      <svg
                        class="w-4 h-4 text-green-600 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"
                        />
                      </svg>
                      <h4 class="font-medium text-green-800 text-sm">
                        Upper Body
                      </h4>
                    </div>
                    <p
                      class="text-green-700 text-sm"
                      id="topRecommendation"
                    ></p>
                  </div>

                  <!-- Lower Body -->
                  <div class="bg-white bg-opacity-60 rounded-lg p-3">
                    <div class="flex items-center mb-2">
                      <svg
                        class="w-4 h-4 text-green-600 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <h4 class="font-medium text-green-800 text-sm">
                        Lower Body
                      </h4>
                    </div>
                    <p
                      class="text-green-700 text-sm"
                      id="bottomRecommendation"
                    ></p>
                  </div>

                  <!-- Footwear -->
                  <div class="bg-white bg-opacity-60 rounded-lg p-3">
                    <div class="flex items-center mb-2">
                      <svg
                        class="w-4 h-4 text-green-600 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-1m6-4V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        />
                      </svg>
                      <h4 class="font-medium text-green-800 text-sm">
                        Footwear
                      </h4>
                    </div>
                    <p
                      class="text-green-700 text-sm"
                      id="footwearRecommendation"
                    ></p>
                  </div>

                  <!-- Accessories -->
                  <div class="bg-white bg-opacity-60 rounded-lg p-3">
                    <div class="flex items-center mb-2">
                      <svg
                        class="w-4 h-4 text-green-600 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <h4 class="font-medium text-green-800 text-sm">
                        Accessories
                      </h4>
                    </div>
                    <p
                      class="text-green-700 text-sm"
                      id="accessoriesRecommendation"
                    ></p>
                  </div>
                </div>
              </div>

              <!-- Weather-specific alerts -->
              <div
                id="weatherAlerts"
                class="hidden bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4"
              >
                <div class="flex items-start">
                  <svg
                    class="w-4 h-4 text-amber-600 mr-2 mt-0.5 flex-shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.966-.833-2.736 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
                    />
                  </svg>
                  <p class="text-amber-800 text-sm" id="weatherAlertText"></p>
                </div>
              </div>

              <div
                id="personalizedNote"
                class="hidden bg-white bg-opacity-70 rounded-lg p-3 text-sm"
              >
                <div class="flex items-start">
                  <svg
                    class="w-4 h-4 text-green-600 mr-2 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                    />
                  </svg>
                  <div>
                    <p class="text-green-600 font-medium">
                      Personalized for you!
                    </p>
                    <p class="text-green-600">
                      Recommendations adjusted for your preferences and activity
                      level.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Refresh Button -->
            <button
              onclick="getWeather()"
              class="w-full bg-gray-100 text-gray-700 py-3 px-6 rounded-xl font-medium hover:bg-gray-200 transition-colors duration-200"
            >
              Refresh Weather
            </button>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center mt-6 text-white text-sm opacity-75">
        <p>Stay comfortable, dress smart! 🌤️</p>
      </div>
    </div>
    <script>
      // OpenWeather API Configuration
      const API_KEY = '2af9656a996aa63081867e24aa1958cd';
      const WEATHER_API_BASE = 'https://api.openweathermap.org/data/2.5';
      const GEO_API_BASE = 'https://api.openweathermap.org/geo/1.0';

      // Global state
      let userProfile = {
        name: "",
        temperaturePreference: "average",
        activityLevel: "moderate",
        stylePreference: "casual",
        workEnvironment: "indoor",
        specialConsiderations: [],
        unitPreference: "auto", // auto, imperial, metric
        countryPreference: "auto", // auto or ISO country code
        hasLearned: false,
      };
      let savedLocation = "";
      let isShowingProfile = false;
      let currentUnits = "imperial"; // imperial or metric
      let currentCountry = null;

      // Global variables for location management
      let currentUserCountry = null;
      let selectedCountry = "";
      let selectedLocation = null;
      let searchTimeout;
      let recentLocations = [];

      // Load saved data on page load
      window.addEventListener("load", function () {
        loadUserData();
        updateUI();
      });

      function loadUserData() {
        console.log("📱 loadUserData called");
        try {
          const profile = localStorage.getItem("weatherWardrobeProfile");
          console.log("📱 Raw profile from localStorage:", profile);

          if (profile) {
            userProfile = JSON.parse(profile);
            console.log("📱 Parsed userProfile:", userProfile);

            // Ensure specialConsiderations is always an array
            if (!Array.isArray(userProfile.specialConsiderations)) {
              userProfile.specialConsiderations = [];
            }
            // Ensure unitPreference has a default value
            if (!userProfile.unitPreference) {
              userProfile.unitPreference = "auto";
              console.log("📱 Set default unitPreference to 'auto'");
            }

            // Ensure countryPreference has a default value
            if (!userProfile.countryPreference) {
              userProfile.countryPreference = "auto";
              console.log("📱 Set default countryPreference to 'auto'");
            }
          } else {
            console.log("📱 No profile found in localStorage, using defaults");
          }

          const location = localStorage.getItem("weatherWardrobeLocation");
          if (location) {
            savedLocation = location;
            console.log("📱 Loaded saved location:", location);

            // Parse saved location to extract country and city for country-first flow
            parseSavedLocationForCountryFirst(location);
          }

          console.log("📱 Final userProfile after load:", userProfile);
        } catch (e) {
          console.log("🚫 Storage not available:", e);
        }
      }

      function parseSavedLocationForCountryFirst(locationString) {
        // Try to extract country and city from saved location for the country-first flow
        console.log("🔍 Parsing saved location for country-first:", locationString);

        // Common patterns: "City, Country" or "City, State, Country"
        const parts = locationString.split(',').map(part => part.trim());

        if (parts.length >= 2) {
          const lastPart = parts[parts.length - 1];

          // Map common country names to codes
          const countryMap = {
            'United States': 'US',
            'Canada': 'CA',
            'United Kingdom': 'GB',
            'Australia': 'AU',
            'Germany': 'DE',
            'France': 'FR',
            'Spain': 'ES',
            'Italy': 'IT',
            'Netherlands': 'NL',
            'Japan': 'JP',
            'South Korea': 'KR',
            'India': 'IN',
            'Brazil': 'BR',
            'Mexico': 'MX',
            'Argentina': 'AR',
            'South Africa': 'ZA',
            'Nigeria': 'NG',
            'Egypt': 'EG',
            'China': 'CN',
            'Thailand': 'TH',
            'Singapore': 'SG',
            'New Zealand': 'NZ',
            'Norway': 'NO',
            'Sweden': 'SE',
            'Denmark': 'DK',
            'Finland': 'FI',
            'Ireland': 'IE',
            'Switzerland': 'CH',
            'Austria': 'AT',
            'Belgium': 'BE',
            'Portugal': 'PT',
            'Greece': 'GR',
            'Poland': 'PL',
            'Czech Republic': 'CZ',
            'Hungary': 'HU',
            'Romania': 'RO',
            'Bulgaria': 'BG',
            'Croatia': 'HR',
            'Slovenia': 'SI',
            'Slovakia': 'SK',
            'Lithuania': 'LT',
            'Latvia': 'LV',
            'Estonia': 'EE',
            'Russia': 'RU',
            'Ukraine': 'UA',
            'Turkey': 'TR',
            'Israel': 'IL',
            'UAE': 'AE',
            'Saudi Arabia': 'SA'
          };

          // Check if last part is a known country
          const countryCode = countryMap[lastPart] || (lastPart.length === 2 ? lastPart.toUpperCase() : null);

          if (countryCode) {
            // Extract city (first part, or first part if there are 3+ parts)
            const cityName = parts[0];

            console.log(`🎯 Parsed: City="${cityName}", Country="${countryCode}"`);

            // Pre-fill the country selector if not already set in profile
            if (!userProfile.countryPreference || userProfile.countryPreference === 'auto') {
              userProfile.countryPreference = countryCode;
              console.log(`💾 Auto-set country preference to ${countryCode} from saved location`);
            }

            return { city: cityName, country: countryCode };
          }
        }

        console.log("❓ Could not parse saved location for country-first flow");
        return null;
      }

      // Unit detection based on country and user preference
      function detectUnits(country) {
        // Check user preference first
        if (userProfile.unitPreference === 'imperial') {
          return 'imperial';
        } else if (userProfile.unitPreference === 'metric') {
          return 'metric';
        }

        // Auto mode: detect based on country
        // Imperial countries: US, Liberia, Myanmar (Burma)
        const imperialCountries = ['US', 'LR', 'MM'];
        return imperialCountries.includes(country) ? 'imperial' : 'metric';
      }

      // Refresh weather display with new units
      function refreshWeatherWithNewUnits() {
        const locationInput = document.getElementById("locationInput");
        const currentLocation = locationInput.value.trim() || savedLocation;

        if (currentLocation) {
          console.log("Refreshing weather with new units:", userProfile.unitPreference, "currentUnits:", currentUnits);
          getWeather();
        }
      }

      // Temperature conversion functions
      function fahrenheitToCelsius(fahrenheit) {
        return (fahrenheit - 32) * 5/9;
      }

      function celsiusToFahrenheit(celsius) {
        return (celsius * 9/5) + 32;
      }

      // Wind speed conversion functions
      function mphToKmh(mph) {
        return mph * 1.60934;
      }

      function formatTemperature(temp, units = currentUnits) {
        const rounded = Math.round(temp);
        return units === 'metric' ? `${rounded}°C` : `${rounded}°F`;
      }

      function formatWindSpeed(speed, units = currentUnits) {
        const rounded = Math.round(speed);
        return units === 'metric' ? `${rounded} km/h` : `${rounded} mph`;
      }
      function updateUI() {
        // Update welcome text
        const welcomeText = document.getElementById("welcomeText");
        if (userProfile.name) {
          welcomeText.textContent = `Hello, ${userProfile.name}!`;
        }

        // Update location display with enhanced formatting
        if (savedLocation) {
          const enhancedLocationText = enhanceSavedLocationDisplay(savedLocation);
          document.getElementById("savedLocationText").textContent = enhancedLocationText;
          document
            .getElementById("savedLocationDiv")
            .classList.remove("hidden");
          document.getElementById("locationInputDiv").classList.add("hidden");
        } else {
          document.getElementById("savedLocationDiv").classList.add("hidden");
          document
            .getElementById("locationInputDiv")
            .classList.remove("hidden");

          // Reset country and city selection for new location input
          document.getElementById("locationCountrySelect").value = userProfile.countryPreference || "";
          document.getElementById("locationInput").value = "";
          document.getElementById("cityInputContainer").style.display = "none";
          document.getElementById("locationInput").disabled = true;

          // Update button state
          validateLocationAndEnableButton();
        }

        // Update profile form
        if (userProfile.name) {
          document.getElementById("userName").value = userProfile.name;
        }

        // Load recent locations for autocomplete
        loadRecentLocations();

        // Update temperature preference buttons
        document.querySelectorAll(".temp-btn").forEach((btn) => {
          const value = btn.getAttribute("data-value");
          if (value === userProfile.temperaturePreference) {
            btn.className =
              "temp-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700";
          } else {
            btn.className =
              "temp-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300";
          }
        });

        // Update activity level buttons
        document.querySelectorAll(".activity-btn").forEach((btn) => {
          const value = btn.getAttribute("data-value");
          if (value === userProfile.activityLevel) {
            btn.className =
              "activity-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700";
          } else {
            btn.className =
              "activity-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300";
          }
        });

        // Update style preference buttons
        document.querySelectorAll(".style-btn").forEach((btn) => {
          const value = btn.getAttribute("data-value");
          if (value === userProfile.stylePreference) {
            btn.className =
              "style-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700";
          } else {
            btn.className =
              "style-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300";
          }
        });

        // Update work environment buttons
        document.querySelectorAll(".work-btn").forEach((btn) => {
          const value = btn.getAttribute("data-value");
          if (value === userProfile.workEnvironment) {
            btn.className =
              "work-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700";
          } else {
            btn.className =
              "work-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300";
          }
        });

        // Update unit preference buttons
        console.log("🎛️ Updating unit preference buttons - current preference:", userProfile.unitPreference);
        document.querySelectorAll(".unit-btn").forEach((btn) => {
          const value = btn.getAttribute("data-value");
          console.log("🎛️ Button:", value, "matches current pref?", value === userProfile.unitPreference);
          if (value === userProfile.unitPreference) {
            btn.className =
              "unit-btn p-3 text-xs border rounded-lg transition-all bg-blue-100 border-blue-500 text-blue-700";
          } else {
            btn.className =
              "unit-btn p-3 text-xs border rounded-lg transition-all bg-white border-gray-300 text-gray-700 hover:border-blue-300";
          }
        });

        // Update location country select dropdown
        const locationCountrySelect = document.getElementById("locationCountrySelect");
        if (locationCountrySelect && userProfile.countryPreference) {
          locationCountrySelect.value = userProfile.countryPreference;
          // If country is selected, show city input
          if (userProfile.countryPreference && userProfile.countryPreference !== 'auto') {
            selectedCountry = userProfile.countryPreference;
            handleCountrySelection(userProfile.countryPreference);
          }
        }

        // Update special considerations checkboxes
        document.querySelectorAll(".special-checkbox").forEach((checkbox) => {
          const value = checkbox.value;
          checkbox.checked =
            userProfile.specialConsiderations &&
            userProfile.specialConsiderations.includes(value);
        });
      }

      // Function to enhance saved location display
      function enhanceSavedLocationDisplay(locationString) {
        console.log("🏷️ Enhancing saved location display:", locationString);

        // If it ends with ", US", try to enhance it
        if (locationString.endsWith(", US")) {
          const cityName = locationString.replace(", US", "");

          // Common NJ cities that might be showing as "City, US"
          const njCities = {
            "Riverside": "Riverside, New Jersey",
            "Newark": "Newark, New Jersey",
            "Trenton": "Trenton, New Jersey",
            "Camden": "Camden, New Jersey",
            "Jersey City": "Jersey City, New Jersey",
            "Paterson": "Paterson, New Jersey",
            "Elizabeth": "Elizabeth, New Jersey",
            "Edison": "Edison, New Jersey",
            "Woodbridge": "Woodbridge, New Jersey",
            "Lakewood": "Lakewood, New Jersey",
            "Toms River": "Toms River, New Jersey",
            "Hamilton": "Hamilton, New Jersey",
            "Clifton": "Clifton, New Jersey",
            "Brick": "Brick, New Jersey",
            "Cherry Hill": "Cherry Hill, New Jersey",
            "Passaic": "Passaic, New Jersey",
            "Union City": "Union City, New Jersey",
            "Vineland": "Vineland, New Jersey",
            "New Brunswick": "New Brunswick, New Jersey",
            "Wayne": "Wayne, New Jersey",
            "Irvington": "Irvington, New Jersey"
          };

          if (njCities[cityName]) {
            console.log(`🏷️ Enhanced "${locationString}" to "${njCities[cityName]}"`);
            return njCities[cityName];
          }

          // If user has country preference set, use that
          const countryPref = userProfile.countryPreference;
          if (countryPref && countryPref !== 'auto') {
            const fullCountryName = getFullCountryName(countryPref);
            const enhanced = `${cityName}, ${fullCountryName}`;
            console.log(`🏷️ Enhanced "${locationString}" to "${enhanced}" using country preference`);
            return enhanced;
          }

          // Default enhancement for US locations
          return `${cityName}, United States`;
        }

        // Return as-is if it doesn't need enhancement
        return locationString;
      }

      function toggleProfile() {
        const profileSection = document.getElementById("profileSection");
        isShowingProfile = !isShowingProfile;

        if (isShowingProfile) {
          profileSection.classList.remove("hidden");
        } else {
          profileSection.classList.add("hidden");
        }
      }

      function setTempPref(pref) {
        userProfile.temperaturePreference = pref;
        updateUI();
      }

      function setActivityLevel(level) {
        userProfile.activityLevel = level;
        updateUI();
      }

      function setStylePref(style) {
        userProfile.stylePreference = style;
        updateUI();
      }

      function setWorkEnv(env) {
        userProfile.workEnvironment = env;
        updateUI();
      }

      function setUnitPref(unit) {
        console.log("🔧 setUnitPref called with:", unit);
        console.log("🔧 Before change - userProfile.unitPreference:", userProfile.unitPreference);
        console.log("🔧 Before change - currentUnits:", currentUnits);

        userProfile.unitPreference = unit;

        // Immediately update current units if not auto
        if (unit !== 'auto') {
          currentUnits = unit;
        } else if (currentCountry) {
          currentUnits = detectUnits(currentCountry);
        }

        console.log("🔧 After change - userProfile.unitPreference:", userProfile.unitPreference);
        console.log("🔧 After change - currentUnits:", currentUnits);
        updateUI();

        // If weather is currently displayed, refresh with new units
        if (!document.getElementById("weatherResults").classList.contains("hidden")) {
          console.log("🔧 Weather is displayed, refreshing with new units");
          refreshWeatherWithNewUnits();
        } else {
          console.log("🔧 Weather not displayed, skipping refresh");
        }
      }

      function toggleSpecialConsideration(consideration) {
        const index = userProfile.specialConsiderations.indexOf(consideration);
        if (index > -1) {
          userProfile.specialConsiderations.splice(index, 1);
        } else {
          userProfile.specialConsiderations.push(consideration);
        }
      }

      function saveProfile() {
        console.log("💾 saveProfile called");
        console.log("💾 Current userProfile before save:", JSON.stringify(userProfile, null, 2));

        const name = document.getElementById("userName").value;
        userProfile.name = name;
        userProfile.hasLearned = true;

        try {
          localStorage.setItem(
            "weatherWardrobeProfile",
            JSON.stringify(userProfile),
          );
          console.log("💾 Profile saved to localStorage");
        } catch (e) {
          console.log("💾 Cannot save to storage");
        }

        toggleProfile();
        updateUI();
        console.log("💾 saveProfile completed");
      }

      function editLocation() {
        // Clear saved location temporarily to force using input field
        savedLocation = "";

        document.getElementById("savedLocationDiv").classList.add("hidden");
        document.getElementById("locationInputDiv").classList.remove("hidden");

        // Reset country and city selection
        const countrySelect = document.getElementById("locationCountrySelect");
        const locationInput = document.getElementById("locationInput");
        const cityContainer = document.getElementById("cityInputContainer");

        // Pre-select user's country preference if available
        if (userProfile.countryPreference && userProfile.countryPreference !== 'auto') {
          countrySelect.value = userProfile.countryPreference;
          selectedCountry = userProfile.countryPreference;
          cityContainer.style.display = 'block';
          locationInput.disabled = false;
          locationInput.focus();
        } else {
          countrySelect.value = "";
          selectedCountry = "";
          cityContainer.style.display = 'none';
          locationInput.disabled = true;
          locationInput.value = "";
        }

        // Update button state
        validateLocationAndEnableButton();

        console.log("Edit mode activated, country-first flow enabled");
      }
      function handleCountrySelection(countryCode) {
        console.log("🌍 Country selected:", countryCode);
        selectedCountry = countryCode;

        const cityContainer = document.getElementById('cityInputContainer');
        const locationInput = document.getElementById('locationInput');
        const getWeatherBtn = document.getElementById('getWeatherBtn');
        const btnText = document.getElementById('getWeatherBtnText');

        console.log("Elements found:", {
          cityContainer: !!cityContainer,
          locationInput: !!locationInput,
          getWeatherBtn: !!getWeatherBtn,
          btnText: !!btnText
        });

        if (countryCode) {
          // Show city input
          if (cityContainer) {
            cityContainer.style.display = 'block';
            console.log("✅ City container shown");
          }
          if (locationInput) {
            locationInput.disabled = false;
            locationInput.focus();
            console.log("✅ Location input enabled");
          }

          // Update button text
          if (btnText) {
            btnText.textContent = 'Enter City/Town/Village';
            console.log("✅ Button text updated");
          }

          // Update placeholder based on country
          const countryNames = {
            'US': 'United States',
            'CA': 'Canada',
            'GB': 'United Kingdom',
            'AU': 'Australia',
            'DE': 'Germany',
            'FR': 'France',
            'ES': 'Spain',
            'IT': 'Italy',
            'NL': 'Netherlands',
            'JP': 'Japan',
            'KR': 'South Korea',
            'IN': 'India',
            'BR': 'Brazil',
            'MX': 'Mexico'
          };

          const countryName = countryNames[countryCode] || 'your country';
          if (locationInput) {
            locationInput.placeholder = `Enter city, town, or village in ${countryName}`;
            console.log("✅ Placeholder updated");
          }

          // Update current country for unit detection
          currentCountry = countryCode;
          currentUnits = detectUnits(countryCode);

          // Save country preference
          userProfile.countryPreference = countryCode;
          try {
            localStorage.setItem("weatherWardrobeProfile", JSON.stringify(userProfile));
          } catch (e) {
            console.log("Cannot save profile");
          }

        } else {
          // Hide city input
          if (cityContainer) {
            cityContainer.style.display = 'none';
          }
          if (locationInput) {
            locationInput.disabled = true;
            locationInput.value = '';
          }

          // Reset button
          if (getWeatherBtn) {
            getWeatherBtn.disabled = true;
          }
          if (btnText) {
            btnText.textContent = 'Select Country & City First';
          }
        }

        // Reset location state
        selectedLocation = null;
        hideLocationSuggestions();
      }

      function validateLocationAndEnableButton() {
        const countrySelect = document.getElementById('locationCountrySelect');
        const locationInput = document.getElementById('locationInput');
        const getWeatherBtn = document.getElementById('getWeatherBtn');
        const btnText = document.getElementById('getWeatherBtnText');

        const hasCountry = countrySelect.value !== '';
        const hasLocation = locationInput.value.trim() !== '';

        if (hasCountry && hasLocation) {
          getWeatherBtn.disabled = false;
          btnText.textContent = 'Get Clothing Advice';
        } else if (hasCountry) {
          getWeatherBtn.disabled = true;
          btnText.textContent = 'Enter City/Town/Village';
        } else {
          getWeatherBtn.disabled = true;
          btnText.textContent = 'Select Country & City First';
        }
      }

      function handleLocationInput(value) {
        clearTimeout(searchTimeout);
        const trimmedValue = value.trim();

        console.log("🎯 Location input:", value, "trimmed:", trimmedValue);

        // Validate button state
        validateLocationAndEnableButton();

        if (trimmedValue.length === 0) {
          hideLocationSuggestions();
          selectedLocation = null;
          return;
        }

        // Reset selected location when user types new input
        selectedLocation = null;

        // If it looks like a complete zip code, don't search for suggestions but show it as an option
        if (/^\d{5}(-\d{4})?$/.test(trimmedValue)) {
          console.log("📮 Detected complete zip code:", trimmedValue);
          showZipCodeSuggestion(trimmedValue);
          return;
        }

        // Debounce search requests - but only search if country is selected
        if (selectedCountry) {
          searchTimeout = setTimeout(() => {
            if (trimmedValue.length >= 2) {
              console.log(`🔍 Starting search for: ${trimmedValue} in ${selectedCountry}`);
              searchLocations(trimmedValue);
            }
          }, 300);
        } else {
          hideLocationSuggestions();
        }
      }

      // Show zip code as a suggestion
      function showZipCodeSuggestion(zipCode) {
        const suggestionsList = document.getElementById("suggestionsList");
        const suggestionsContainer = document.getElementById("locationSuggestions");

        const zipLocation = {
          name: zipCode,
          country: 'US',
          isZipCode: true
        };

        displayLocationSuggestions([zipLocation]);
      }

      function selectLocation(location, displayName) {
        // Handle zip codes specially
        if (location.isZipCode) {
          document.getElementById("locationInput").value = location.name;
          selectedLocation = location.name; // Just store the zip as a string
          hideLocationSuggestions();
          validateLocationAndEnableButton();
          return;
        }
        
        // Rest of the existing function for normal locations
        selectedLocation = location;
        document.getElementById("locationInput").value = displayName;
        hideLocationSuggestions();

        // Add to recent locations
        addToRecentLocations(location, displayName);
        
        // Validate and enable button
        validateLocationAndEnableButton();
      }

      function addToRecentLocations(location, displayName) {
        // Remove if already exists
        recentLocations = recentLocations.filter(
          (item) => item.displayName !== displayName,
        );

        // Add to front
        recentLocations.unshift({ location, displayName });

        // Keep only last 5
        recentLocations = recentLocations.slice(0, 5);

        // Save to localStorage
        try {
          localStorage.setItem(
            "weatherWardrobeRecentLocations",
            JSON.stringify(recentLocations),
          );
        } catch (e) {
          console.log("Cannot save recent locations");
        }
      }

      function loadRecentLocations() {
        try {
          const saved = localStorage.getItem("weatherWardrobeRecentLocations");
          if (saved) {
            recentLocations = JSON.parse(saved);
          }
        } catch (e) {
          console.log("Cannot load recent locations");
        }
      }

      function showRecentSuggestions() {
        if (
          recentLocations.length > 0 &&
          document.getElementById("locationInput").value.trim() === ""
        ) {
          const suggestionsList = document.getElementById("suggestionsList");
          const suggestionsContainer = document.getElementById(
            "locationSuggestions",
          );

          suggestionsList.innerHTML =
            '<div class="px-4 py-2 text-xs font-medium text-gray-500 uppercase tracking-wide">Recent Locations</div>';

          recentLocations.forEach((item) => {
            const suggestionItem = document.createElement("div");
            suggestionItem.className = "suggestion-item text-sm";
            suggestionItem.innerHTML = `
              <div class="font-medium text-gray-900">${item.displayName}</div>
              <div class="text-xs text-gray-500">Recent</div>
            `;

            suggestionItem.onclick = () =>
              selectLocation(item.location, item.displayName);
            suggestionsList.appendChild(suggestionItem);
          });

          suggestionsContainer.classList.remove("hidden");
        }
      }

      function hideLocationSuggestions() {
        document.getElementById("locationSuggestions").classList.add("hidden");
      }

      function showLocationNote(message) {
        // Create or update location note div
        let noteDiv = document.getElementById('locationNote');
        if (!noteDiv) {
          noteDiv = document.createElement('div');
          noteDiv.id = 'locationNote';
          noteDiv.className = 'bg-blue-50 border border-blue-200 rounded-xl p-3 mb-4 text-blue-700 text-sm';

          const errorDiv = document.getElementById('errorDiv');
          errorDiv.parentNode.insertBefore(noteDiv, errorDiv);
        }

        noteDiv.textContent = message;
        noteDiv.classList.remove('hidden');

        // Auto-hide after 5 seconds
        setTimeout(() => {
          noteDiv.classList.add('hidden');
        }, 5000);
      }

      function showError(message) {
        document.getElementById("errorText").textContent = message;
        document.getElementById("errorDiv").classList.remove("hidden");
      }

      function hideError() {
        document.getElementById("errorDiv").classList.add("hidden");
      }
      async function searchLocations(query) {
        const suggestionsList = document.getElementById("suggestionsList");
        const loadingDiv = document.getElementById("loadingSuggestion");
        const suggestionsContainer = document.getElementById("locationSuggestions");

        if (query.trim().length < 2 || !selectedCountry) {
          suggestionsContainer.classList.add("hidden");
          return;
        }

        // Show loading state
        suggestionsList.innerHTML = "";
        loadingDiv.classList.remove("hidden");
        suggestionsContainer.classList.remove("hidden");

        console.log(`🔍 Searching for locations: "${query}" in ${selectedCountry}`);

        try {
          // Use OpenWeather geocoding API to search within the selected country
          const searchQuery = `${query.trim()},${selectedCountry}`;
          const geocodingUrl = `${GEO_API_BASE}/direct?q=${encodeURIComponent(searchQuery)}&limit=5&appid=${API_KEY}`;

          const response = await fetch(geocodingUrl);
          let locations = [];

          if (response.ok) {
            locations = await response.json();
            console.log(`🔍 OpenWeather found ${locations.length} suggestions for "${query}" in ${selectedCountry}`);
          } else {
            console.log('⚠️ OpenWeather geocoding failed, using fallback');
            // Fallback to simple text matching
            locations = createSimpleFallbackSuggestions(query, selectedCountry);
          }

          if (locations.length > 0) {
            displayLocationSuggestions(locations);
          } else {
            const countryName = getFullCountryName(selectedCountry);
            suggestionsList.innerHTML = `
              <div class="px-4 py-2 text-sm text-gray-500">
                <div class="font-medium mb-1">No locations found for "${query}"</div>
                <div class="text-xs">
                  💡 Try a larger nearby city in ${countryName}
                </div>
              </div>
            `;
          }
        } catch (error) {
          console.error('🔍 Search error:', error);
          const countryName = getFullCountryName(selectedCountry);
          suggestionsList.innerHTML = `
            <div class="px-4 py-2 text-sm text-gray-500">
              <div class="font-medium mb-1">Unable to search locations</div>
              <div class="text-xs">Try a major city name in ${countryName}</div>
            </div>
          `;
        }

        loadingDiv.classList.add("hidden");
      }

      function createSimpleFallbackSuggestions(query, countryCode) {
        // Simple fallback suggestions for major cities when API fails
        const majorCities = {
          'US': ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Antonio', 'San Diego', 'Dallas', 'San Jose'],
          'CA': ['Toronto', 'Montreal', 'Vancouver', 'Calgary', 'Ottawa', 'Edmonton', 'Mississauga', 'Winnipeg', 'Quebec City', 'Hamilton'],
          'GB': ['London', 'Birmingham', 'Manchester', 'Liverpool', 'Sheffield', 'Bristol', 'Glasgow', 'Leicester', 'Edinburgh', 'Leeds'],
          'AU': ['Sydney', 'Melbourne', 'Brisbane', 'Perth', 'Adelaide', 'Gold Coast', 'Newcastle', 'Canberra', 'Wollongong', 'Logan'],
          'DE': ['Berlin', 'Hamburg', 'Munich', 'Cologne', 'Frankfurt', 'Stuttgart', 'Düsseldorf', 'Dortmund', 'Essen', 'Leipzig'],
          'FR': ['Paris', 'Marseille', 'Lyon', 'Toulouse', 'Nice', 'Nantes', 'Strasbourg', 'Montpellier', 'Bordeaux', 'Lille'],
          'ES': ['Madrid', 'Barcelona', 'Valencia', 'Seville', 'Zaragoza', 'Málaga', 'Murcia', 'Palma', 'Las Palmas', 'Bilbao'],
          'IT': ['Rome', 'Milan', 'Naples', 'Turin', 'Palermo', 'Genoa', 'Bologna', 'Florence', 'Bari', 'Catania']
        };

        const cities = majorCities[countryCode] || [];
        const queryLower = query.toLowerCase();

        return cities
          .filter(city => city.toLowerCase().includes(queryLower))
          .slice(0, 3)
          .map(city => ({
            name: city,
            country: countryCode,
            state: null,
            lat: null,
            lon: null,
            isFallback: true
          }));
      }

      function displayLocationSuggestions(locations) {
        const suggestionsList = document.getElementById("suggestionsList");
        const suggestionsContainer = document.getElementById(
          "locationSuggestions",
        );

        suggestionsList.innerHTML = "";

        if (locations.length === 0) {
          suggestionsList.innerHTML =
            '<div class="px-4 py-2 text-sm text-gray-500">No locations found</div>';
          return;
        }

        // Group locations by name to highlight duplicates
        const locationGroups = {};
        locations.forEach(location => {
          const name = location.name;
          if (!locationGroups[name]) {
            locationGroups[name] = [];
          }
          locationGroups[name].push(location);
        });

        locations.forEach((location) => {
          const displayName = formatLocationName(location);
          const suggestionItem = document.createElement("div");
          suggestionItem.className = "suggestion-item text-sm";

          // Create status and detail text
          let statusText = "";
          let statusClass = "text-xs text-gray-500";

          // Check if this is a duplicate name (multiple locations with same name)
          const isDuplicate = locationGroups[location.name].length > 1;

          if (location.isZipCode) {
            statusText = "📮 ZIP Code";
            statusClass = "text-xs text-blue-600";
          } else if (location.popular) {
            statusText = "⭐ Popular location";
            statusClass = "text-xs text-green-600";
          } else if (location.verified) {
            if (isDuplicate) {
              // For duplicates, emphasize the state/country difference
              statusText = "📍 Multiple locations - choose your region";
              statusClass = "text-xs text-blue-600";
            } else {
              statusText = "✅ Found location";
              statusClass = "text-xs text-green-600";
            }
          } else if (location.partialMatch) {
            statusText = "🔍 Similar location";
            statusClass = "text-xs text-purple-600";
          } else if (location.needsState) {
            statusText = "💡 Try adding state (e.g., \"" + location.name + ", NJ\")";
            statusClass = "text-xs text-orange-600";
          } else if (location.userInput) {
            statusText = "📝 As entered";
            statusClass = "text-xs text-gray-600";
          } else {
            statusText = "📍 Location";
            statusClass = "text-xs text-gray-600";
          }

          // Highlight duplicate names differently
          const nameClass = isDuplicate ? "font-semibold text-gray-900" : "font-medium text-gray-900";

          suggestionItem.innerHTML = `
            <div class="${nameClass}">${displayName}</div>
            <div class="${statusClass}">${statusText}</div>
          `;

          suggestionItem.onclick = () => selectLocation(location, displayName);
          suggestionsList.appendChild(suggestionItem);
        });

        // Add helpful tip if there are duplicate names
        const duplicateNames = Object.keys(locationGroups).filter(name => locationGroups[name].length > 1);
        if (duplicateNames.length > 0) {
          const tipDiv = document.createElement("div");
          tipDiv.className = "px-4 py-2 bg-blue-50 border-t border-blue-200";
          tipDiv.innerHTML = `
            <div class="text-xs text-blue-700">
              💡 Multiple locations found. Choose the one in your state/region.
            </div>
          `;
          suggestionsList.appendChild(tipDiv);
        }

        suggestionsContainer.classList.remove("hidden");
      }

      function formatLocationName(location) {
        console.log("📍 Formatting location:", location);

        if (!location || !location.name) {
          console.warn("⚠️ Invalid location object:", location);
          return "Unknown Location";
        }

        // Handle zip codes
        if (location.isZipCode) {
          return `${location.name} (ZIP Code)`;
        }

        // Handle US locations with state (show full state name)
        if (location.country === 'US' && location.state && location.state !== 'Unknown') {
          const fullStateName = getFullStateName(location.state);
          return `${location.name}, ${fullStateName}`;
        }
        // Handle non-US locations with state/province
        else if (location.state && location.state !== 'Unknown' && location.country !== 'US') {
          return `${location.name}, ${location.state}, ${location.country}`;
        }
        // Handle locations with country only
        else if (location.country && location.country !== 'Unknown') {
          // For US locations without state, still show US for clarity
          if (location.country === 'US') {
            return `${location.name}, United States`;
          }
          return `${location.name}, ${getFullCountryName(location.country)}`;
        }

        // Default to just the name
        return location.name;
      }

      async function findNearestCityWithWeather(cityName, countryCode) {
        console.log(`🔍 Searching for weather data for ${cityName} in ${countryCode}`);

        try {
          // First, try the exact city name
          const searchQuery = `${cityName},${countryCode}`;
          const weatherUrl = `${WEATHER_API_BASE}/weather?q=${encodeURIComponent(searchQuery)}&units=${currentUnits}&appid=${API_KEY}`;
          const response = await fetch(weatherUrl);

          if (response.ok) {
            const data = await response.json();
            console.log(`✅ Found weather data for ${cityName}`);
            return { city: cityName, data: data, isExact: true };
          }

          // If exact match fails, try to find nearby cities using geocoding
          console.log(`⚠️ No exact match for ${cityName}, searching for nearby cities...`);

          const geocodingUrl = `${GEO_API_BASE}/direct?q=${encodeURIComponent(searchQuery)}&limit=5&appid=${API_KEY}`;
          const geoResponse = await fetch(geocodingUrl);

          if (geoResponse.ok) {
            const locations = await geoResponse.json();

            // Try each location returned by geocoding
            for (const location of locations) {
              try {
                const nearbyWeatherUrl = `${WEATHER_API_BASE}/weather?lat=${location.lat}&lon=${location.lon}&units=${currentUnits}&appid=${API_KEY}`;
                const nearbyResponse = await fetch(nearbyWeatherUrl);

                if (nearbyResponse.ok) {
                  const nearbyData = await nearbyResponse.json();
                  console.log(`✅ Found weather data for nearby city: ${location.name}`);
                  return {
                    city: location.name,
                    state: location.state,
                    country: location.country,
                    data: nearbyData,
                    isExact: false,
                    originalSearch: cityName
                  };
                }
              } catch (nearbyError) {
                console.log(`❌ Failed to get weather for ${location.name}:`, nearbyError);
                continue;
              }
            }
          }

          throw new Error(`No weather data available for ${cityName} or nearby areas`);

        } catch (error) {
          console.error(`❌ Error finding weather data for ${cityName}:`, error);
          throw error;
        }
      }
      async function getWeather() {
        console.log("🌤️ getWeather function called");

        const locationInput = document.getElementById("locationInput");
        const countrySelect = document.getElementById("locationCountrySelect");
        const cityName = locationInput.value.trim();
        const countryCode = countrySelect.value;

        // Validate inputs
        if (!countryCode) {
          showError("Please select your country first");
          return;
        }

        if (!cityName) {
          showError("Please enter your city, town, or village");
          return;
        }

        console.log(`🌍 Searching for weather: ${cityName} in ${countryCode}`);

        // Show loading state
        const button = document.getElementById("getWeatherBtn");
        const btnText = document.getElementById("getWeatherBtnText");
        if (button) {
          const originalText = btnText.textContent;
          button.innerHTML = '<div class="spinner mx-auto"></div>';
          button.disabled = true;
        }

        hideError();

        try {
          // Set units based on country and user preference
          if (userProfile.unitPreference !== 'auto') {
            currentUnits = userProfile.unitPreference;
          } else {
            currentUnits = detectUnits(countryCode);
          }
          currentCountry = countryCode;

          console.log(`🎛️ Using units: ${currentUnits} for country: ${countryCode}`);

          // Try to find weather data for the location
          const weatherResult = await findNearestCityWithWeather(cityName, countryCode);

          if (weatherResult) {
            // Get forecast data
            let forecastData = null;
            try {
              const forecastUrl = `${WEATHER_API_BASE}/forecast?q=${encodeURIComponent(weatherResult.city + ',' + countryCode)}&units=${currentUnits}&appid=${API_KEY}`;
              const forecastResponse = await fetch(forecastUrl);
              if (forecastResponse.ok) {
                forecastData = await forecastResponse.json();
              }
            } catch (forecastError) {
              console.log("⚠️ Forecast failed:", forecastError);
            }

            // Process forecast
            const todaysForecast = forecastData
              ? getTodaysForecast(forecastData)
              : getSimpleForecast(weatherResult.data);

            // Create display location name
            let locationDisplay = weatherResult.city;
            if (weatherResult.state) {
              locationDisplay += `, ${weatherResult.state}`;
            }
            locationDisplay += `, ${weatherResult.country || getFullCountryName(countryCode)}`;

            // Add note if not exact match
            if (!weatherResult.isExact) {
              locationDisplay += ` (nearest available)`;
              console.log(`ℹ️ Using nearest city: ${weatherResult.city} instead of ${weatherResult.originalSearch}`);

              // Show info message to user
              showLocationNote(`Weather data for "${weatherResult.originalSearch}" not available. Showing data for nearest city: ${weatherResult.city}`);
            }

            const weatherData = {
              location: locationDisplay,
              temperature: Math.round(weatherResult.data.main.temp),
              condition: weatherResult.data.weather[0].main,
              humidity: weatherResult.data.main.humidity,
              windSpeed: Math.round(weatherResult.data.wind?.speed || 0),
              feelsLike: Math.round(weatherResult.data.main.feels_like),
              forecast: todaysForecast,
            };

            displayWeather(weatherData);

            // Save location for quick access
            const saveLocation = `${cityName}, ${getFullCountryName(countryCode)}`;
            savedLocation = saveLocation;
            try {
              localStorage.setItem("weatherWardrobeLocation", savedLocation);
            } catch (e) {
              console.log("Cannot save location");
            }
            updateUI();

          } else {
            throw new Error("No weather data available");
          }

        } catch (error) {
          console.error("❌ Weather lookup failed:", error);

          let errorMessage = `Unable to find weather data for "${cityName}" in ${getFullCountryName(countryCode)}. `;
          errorMessage += "Please try:\n";
          errorMessage += "• A larger nearby city\n";
          errorMessage += "• Different spelling\n";
          errorMessage += "• Official city name in English";

          showError(errorMessage);
        } finally {
          // Reset button
          if (button && btnText) {
            button.innerHTML = '<span id="getWeatherBtnText">Get Clothing Advice</span>';
            button.disabled = false;
          }
        }
      }

      function getSimpleForecast(currentData) {
        // Create a simple forecast based on current weather when detailed forecast fails
        const currentTemp = Math.round(currentData.main.temp);
        const alerts = [];

        // Generate some basic forecast info
        const high = currentTemp + Math.floor(Math.random() * 10) + 2; // 2-12 degrees higher
        const low = currentTemp - Math.floor(Math.random() * 15) - 5; // 5-20 degrees lower

        // Add some basic alerts based on current conditions
        if (currentData.weather[0].main.toLowerCase().includes("thunder")) {
          alerts.push(
            "Thunderstorms possible - bring an umbrella and avoid outdoor activities!",
          );
        }
        if (currentData.wind?.speed > 10) {
          alerts.push(
            "Windy conditions continuing - secure clothing and accessories!",
          );
        }
        if (high - currentTemp > 8) {
          alerts.push(
            `Temperature may rise to ${formatTemperature(high)} later - dress in layers!`,
          );
        }

        return {
          high,
          low,
          afternoon: currentData.weather[0].main,
          evening: currentData.weather[0].main,
          alerts:
            alerts.length > 0
              ? alerts
              : [`High: ${formatTemperature(high)}, Low: ${formatTemperature(low)} expected today`],
        };
      }

      function getTodaysForecast(forecastData) {
        if (
          !forecastData ||
          !forecastData.list ||
          forecastData.list.length === 0
        ) {
          console.log("No forecast data available");
          return null;
        }

        const today = new Date();
        const todayStr = today.toISOString().split("T")[0]; // YYYY-MM-DD format

        // Filter today's forecast entries (3-hour intervals)
        const todaysEntries = forecastData.list.filter((entry) => {
          const entryDate = new Date(entry.dt * 1000)
            .toISOString()
            .split("T")[0];
          return entryDate === todayStr;
        });

        console.log("Today entries found:", todaysEntries.length);

        if (todaysEntries.length === 0) {
          // If no entries for today, use tomorrow's data
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          const tomorrowStr = tomorrow.toISOString().split("T")[0];

          const tomorrowEntries = forecastData.list
            .filter((entry) => {
              const entryDate = new Date(entry.dt * 1000)
                .toISOString()
                .split("T")[0];
              return entryDate === tomorrowStr;
            })
            .slice(0, 3); // Just first 3 entries of tomorrow

          if (tomorrowEntries.length === 0) {
            return null;
          }

          const temps = tomorrowEntries.map((entry) => entry.main.temp);
          return {
            high: Math.round(Math.max(...temps)),
            low: Math.round(Math.min(...temps)),
            afternoon: tomorrowEntries[0]?.weather[0].main || "Unknown",
            evening: tomorrowEntries[1]?.weather[0].main || "Unknown",
            alerts: ["Showing tomorrow's forecast"],
          };
        }

        // Find high and low temps for today
        const temps = todaysEntries.map((entry) => entry.main.temp);
        console.log("📈 Today's forecast temperatures:", temps);
        console.log("📈 Number of forecast entries for today:", todaysEntries.length);

        const high = Math.round(Math.max(...temps));
        const low = Math.round(Math.min(...temps));

        console.log("📈 Calculated high:", high, "low:", low);

        // If high and low are the same, use a reasonable spread
        let adjustedHigh = high;
        let adjustedLow = low;

        if (high === low && todaysEntries.length === 1) {
          // Only one data point - create realistic high/low spread
          console.log("📈 Only one forecast point - creating realistic spread");
          adjustedHigh = high + 3; // 3 degrees higher
          adjustedLow = low - 5;   // 5 degrees lower
          console.log("📈 Adjusted high:", adjustedHigh, "low:", adjustedLow);
        }

        // Get afternoon and evening conditions
        const currentHour = today.getHours();
        const afternoonEntry = todaysEntries.find((entry) => {
          const hour = new Date(entry.dt * 1000).getHours();
          return hour >= 14 && hour <= 17; // 2 PM - 5 PM
        });
        const eveningEntry = todaysEntries.find((entry) => {
          const hour = new Date(entry.dt * 1000).getHours();
          return hour >= 18 && hour <= 21; // 6 PM - 9 PM
        });

        // Generate alerts based on forecast
        const alerts = [];

        // Check for rain/snow later
        const laterEntries = todaysEntries.filter((entry) => {
          const hour = new Date(entry.dt * 1000).getHours();
          return hour > currentHour;
        });

        const rainLater = laterEntries.some(
          (entry) =>
            entry.weather[0].main.toLowerCase().includes("rain") ||
            entry.weather[0].main.toLowerCase().includes("drizzle"),
        );
        const snowLater = laterEntries.some((entry) =>
          entry.weather[0].main.toLowerCase().includes("snow"),
        );
        const windyLater = laterEntries.some(
          (entry) => (entry.wind?.speed || 0) > 15,
        );

        if (rainLater)
          alerts.push(
            "Rain expected later today - consider bringing an umbrella!",
          );
        if (snowLater)
          alerts.push("Snow expected later - pack extra warm layers!");
        if (windyLater)
          alerts.push("Getting windier later - consider a windbreaker!");

        // Temperature change alerts
        const currentTemp = Math.round(todaysEntries[0]?.main.temp || 0);
        if (high - currentTemp > 10) {
          alerts.push(`Warming up significantly - high of ${formatTemperature(high)} expected!`);
        }
        if (currentTemp - low > 10 && currentHour < 18) {
          alerts.push(`Cooling down later - low of ${formatTemperature(low)} tonight!`);
        }

        // If no specific alerts, add a general one
        if (alerts.length === 0) {
          alerts.push(`High: ${formatTemperature(adjustedHigh)}, Low: ${formatTemperature(adjustedLow)} expected today`);
        }

        return {
          high: adjustedHigh,
          low: adjustedLow,
          afternoon: afternoonEntry?.weather[0].main || "Similar conditions",
          evening: eveningEntry?.weather[0].main || "Similar conditions",
          alerts,
        };
      }

      function displayWeather(weather) {
        console.log("🌡️ displayWeather called");
        console.log("🌡️ userProfile.unitPreference:", userProfile.unitPreference);
        console.log("🌡️ currentUnits:", currentUnits);
        console.log("🌡️ Original weather data:", weather);

        // Update weather info
        document.getElementById("weatherLocation").textContent =
          weather.location;
        document.getElementById("weatherTemp").textContent =
          formatTemperature(weather.temperature);
        document.getElementById("weatherCondition").textContent =
          weather.condition;
        document.getElementById("feelsLike").textContent =
          formatTemperature(weather.feelsLike);
        document.getElementById("humidity").textContent =
          weather.humidity + "%";
        document.getElementById("windSpeed").textContent =
          formatWindSpeed(weather.windSpeed);

        // Update weather icon
        const iconContainer = document.getElementById("weatherIcon");
        iconContainer.innerHTML = getWeatherIcon(weather.condition);

        // Update today's forecast if available
        const forecastContainer = document.getElementById("todaysForecast");
        if (weather.forecast) {
          console.log("Displaying forecast:", weather.forecast);
          let forecastHTML = `
                    <div class="bg-blue-50 rounded-xl p-4 mt-4">
                        <h4 class="font-semibold text-blue-800 mb-2">📅 Today's Forecast</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-3">
                            <div class="text-center">
                                <p class="text-blue-600">High</p>
                                <p class="font-bold text-blue-800">${formatTemperature(weather.forecast.high)}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-blue-600">Low</p>
                                <p class="font-bold text-blue-800">${formatTemperature(weather.forecast.low)}</p>
                            </div>
                        </div>
                `;

          if (weather.forecast.alerts && weather.forecast.alerts.length > 0) {
            forecastHTML += '<div class="space-y-1">';
            weather.forecast.alerts.forEach((alert) => {
              forecastHTML += `<p class="text-blue-700 text-xs">⚠️ ${alert}</p>`;
            });
            forecastHTML += "</div>";
          }

          forecastHTML += "</div>";
          forecastContainer.innerHTML = forecastHTML;
          forecastContainer.classList.remove("hidden");
        } else {
          console.log("No forecast data to display");
          forecastContainer.classList.add("hidden");
        }

        // Update clothing advice with detailed categorized recommendations
        const advice = getClothingRecommendation(
          weather.temperature,
          weather.condition,
          weather.forecast,
        );

        // Show personalized note if applicable
        if (userProfile.hasLearned) {
          document
            .getElementById("personalizedNote")
            .classList.remove("hidden");
        }

        // Show results
        document.getElementById("weatherResults").classList.remove("hidden");
      }

      function getWeatherIcon(condition) {
        const lowerCondition = condition.toLowerCase();
        if (
          lowerCondition.includes("rain") ||
          lowerCondition.includes("drizzle")
        ) {
          return `<svg class="weather-icon text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M8 19v2m8-2v2m-4-3v2m-4-5v2"/>
                </svg>`;
        } else if (lowerCondition.includes("cloud")) {
          return `<svg class="weather-icon text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                </svg>`;
        } else {
          return `<svg class="weather-icon text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>`;
        }
      }
      function getClothingRecommendation(temp, condition, forecast) {
        const lowerCondition = condition.toLowerCase();
        let baseTemp = temp;

        // Adjust temperature based on user preferences
        if (userProfile.temperaturePreference === "runs-hot") {
          baseTemp += 10;
        } else if (userProfile.temperaturePreference === "runs-cold") {
          baseTemp -= 10;
        }

        // Adjust for activity level
        if (userProfile.activityLevel === "active") {
          baseTemp += 5; // Active people get warmer
        } else if (userProfile.activityLevel === "sedentary") {
          baseTemp -= 3; // Sedentary people might feel cooler
        }

        // Get detailed recommendations by category
        const recommendations = getDetailedClothingRecommendations(
          baseTemp,
          lowerCondition,
          forecast,
        );

        // Update each category in the UI
        const topEl = document.getElementById("topRecommendation");
        const bottomEl = document.getElementById("bottomRecommendation");
        const footwearEl = document.getElementById("footwearRecommendation");
        const accessoriesEl = document.getElementById(
          "accessoriesRecommendation",
        );
        const alertDiv = document.getElementById("weatherAlerts");
        const alertText = document.getElementById("weatherAlertText");

        console.log("Elements found:", {
          topEl: !!topEl,
          bottomEl: !!bottomEl,
          footwearEl: !!footwearEl,
          accessoriesEl: !!accessoriesEl,
          alertDiv: !!alertDiv,
          alertText: !!alertText,
        });

        if (topEl) topEl.textContent = recommendations.top;
        if (bottomEl) bottomEl.textContent = recommendations.bottom;
        if (footwearEl) footwearEl.textContent = recommendations.footwear;
        if (accessoriesEl)
          accessoriesEl.textContent = recommendations.accessories;

        // Handle weather alerts
        if (recommendations.alerts && recommendations.alerts.length > 0) {
          alertText.textContent = recommendations.alerts.join(" ");
          alertDiv.classList.remove("hidden");
        } else {
          alertDiv.classList.add("hidden");
        }

        // Return a summary for backward compatibility
        return `${recommendations.top} ${recommendations.bottom} ${recommendations.footwear}`;
      }

      function getDetailedClothingRecommendations(
        baseTemp,
        condition,
        forecast,
      ) {
        const style = userProfile.stylePreference;
        const isRainy =
          condition.includes("rain") || condition.includes("drizzle");
        const isSnowy = condition.includes("snow");
        const isWindy = condition.includes("wind");

        let recommendations = {
          top: "",
          bottom: "",
          footwear: "",
          accessories: "",
          alerts: [],
        };

        // Normalize temperature to Fahrenheit for consistent thresholds
        let tempForClothing = baseTemp;
        if (currentUnits === 'metric') {
          tempForClothing = celsiusToFahrenheit(baseTemp);
        }

        // Upper Body Recommendations (using Fahrenheit thresholds)
        if (tempForClothing >= 80) {
          if (style === "professional") {
            recommendations.top =
              "Lightweight button-down, breathable blouse, or linen shirt";
          } else if (style === "sporty") {
            recommendations.top =
              "Moisture-wicking tank top or performance t-shirt";
          } else if (style === "fashion") {
            recommendations.top =
              "Stylish crop top, trendy tank, or flowy blouse";
          } else {
            recommendations.top =
              "Light cotton t-shirt, tank top, or sleeveless top";
          }
        } else if (tempForClothing >= 70) {
          if (style === "professional") {
            recommendations.top =
              "Cotton button-down, polo shirt, or lightweight blouse";
          } else if (style === "sporty") {
            recommendations.top =
              "Athletic t-shirt, performance polo, or workout top";
          } else if (style === "fashion") {
            recommendations.top =
              "Trendy t-shirt, fashion top, or lightweight cardigan";
          } else {
            recommendations.top =
              "Comfortable t-shirt, casual button-down, or light sweater";
          }
        } else if (tempForClothing >= 60) {
          if (style === "professional") {
            recommendations.top =
              "Long-sleeve shirt with light blazer or cardigan";
          } else if (style === "sporty") {
            recommendations.top =
              "Long-sleeve athletic shirt or lightweight hoodie";
          } else if (style === "fashion") {
            recommendations.top =
              "Stylish sweater, fashion cardigan, or layered look";
          } else {
            recommendations.top =
              "Long-sleeve shirt, light sweater, or thin hoodie";
          }
        } else if (tempForClothing >= 50) {
          if (style === "professional") {
            recommendations.top =
              "Wool sweater, thick blazer, or professional cardigan";
          } else if (style === "sporty") {
            recommendations.top =
              "Fleece jacket, thick hoodie, or athletic sweatshirt";
          } else if (style === "fashion") {
            recommendations.top =
              "Trendy sweater, oversized cardigan, or stylish jacket";
          } else {
            recommendations.top =
              "Medium-weight sweater, hoodie, or casual jacket";
          }
        } else if (tempForClothing >= 40) {
          recommendations.top = "Warm sweater or fleece with insulating layers";
        } else if (tempForClothing >= 30) {
          recommendations.top =
            "Heavy sweater, thermal base layer, and warm coat";
        } else {
          recommendations.top =
            "Multiple layers: thermal underwear, heavy sweater, winter coat";
        }

        // Lower Body Recommendations
        if (tempForClothing >= 80) {
          if (style === "professional") {
            recommendations.bottom =
              "Lightweight dress pants, knee-length skirt, or professional shorts";
          } else if (style === "sporty") {
            recommendations.bottom =
              "Athletic shorts, performance leggings, or gym wear";
          } else if (style === "fashion") {
            recommendations.bottom =
              "High-waisted shorts, mini skirt, or trendy capris";
          } else {
            recommendations.bottom =
              "Shorts, lightweight pants, or summer dress";
          }
        } else if (tempForClothing >= 70) {
          if (style === "professional") {
            recommendations.bottom =
              "Dress pants, midi skirt, or tailored trousers";
          } else if (style === "sporty") {
            recommendations.bottom = "Athletic pants, leggings, or joggers";
          } else if (style === "fashion") {
            recommendations.bottom =
              "Jeans, fashionable pants, or stylish skirt";
          } else {
            recommendations.bottom =
              "Jeans, casual pants, or comfortable skirt";
          }
        } else if (tempForClothing >= 50) {
          if (style === "professional") {
            recommendations.bottom =
              "Wool pants, warm skirt with tights, or dress slacks";
          } else if (style === "sporty") {
            recommendations.bottom =
              "Thermal leggings, warm athletic pants, or fleece-lined joggers";
          } else {
            recommendations.bottom = "Jeans, warm pants, or thick leggings";
          }
        } else if (tempForClothing >= 30) {
          recommendations.bottom =
            "Insulated pants, thermal leggings, or winter trousers";
        } else {
          recommendations.bottom =
            "Thermal underwear with heavy pants or insulated winter gear";
        }

        // Footwear Recommendations
        if (tempForClothing >= 80) {
          if (style === "professional") {
            recommendations.footwear =
              "Breathable dress shoes, professional sandals, or loafers";
          } else if (style === "sporty") {
            recommendations.footwear =
              "Athletic shoes, running sandals, or sport slides";
          } else if (style === "fashion") {
            recommendations.footwear =
              "Stylish sandals, fashion sneakers, or trendy flats";
          } else {
            recommendations.footwear =
              "Sandals, flip-flops, or breathable sneakers";
          }
        } else if (tempForClothing >= 70) {
          if (style === "professional") {
            recommendations.footwear =
              "Dress shoes, professional flats, or loafers";
          } else if (style === "sporty") {
            recommendations.footwear =
              "Sneakers, athletic shoes, or casual trainers";
          } else {
            recommendations.footwear =
              "Comfortable shoes, casual sneakers, or flats";
          }
        } else if (tempForClothing >= 50) {
          if (style === "professional") {
            recommendations.footwear =
              "Closed-toe dress shoes or professional ankle boots";
          } else {
            recommendations.footwear =
              "Sneakers, boots, or warm closed-toe shoes";
          }
        } else if (tempForClothing >= 30) {
          recommendations.footwear =
            "Insulated boots or warm winter shoes with good traction";
        } else {
          recommendations.footwear =
            "Waterproof winter boots with thermal insulation";
        }

        // Accessories Recommendations
        if (tempForClothing >= 80) {
          recommendations.accessories = "Sunglasses, sun hat, and sunscreen";
        } else if (tempForClothing >= 70) {
          recommendations.accessories =
            "Light accessories, sunglasses if sunny";
        } else if (tempForClothing >= 60) {
          recommendations.accessories = "Light scarf or jacket you can remove";
        } else if (tempForClothing >= 50) {
          recommendations.accessories = "Scarf, light gloves, or warm hat";
        } else if (tempForClothing >= 40) {
          recommendations.accessories = "Warm scarf, gloves, and beanie or hat";
        } else if (tempForClothing >= 30) {
          recommendations.accessories =
            "Insulated gloves, warm hat, thick scarf";
        } else {
          recommendations.accessories =
            "Full winter accessories: thermal gloves, warm hat, thick scarf";
        }

        // Weather-specific alerts and adjustments
        if (isRainy) {
          recommendations.alerts.push(
            "Rain expected - bring umbrella and waterproof footwear!",
          );
          if (
            recommendations.footwear.includes("sandals") ||
            recommendations.footwear.includes("flats")
          ) {
            recommendations.footwear = "Water-resistant shoes or rain boots";
          }
        }

        if (isSnowy) {
          recommendations.alerts.push(
            "Snow conditions - wear waterproof boots with good traction!",
          );
          recommendations.footwear =
            "Waterproof winter boots with anti-slip soles";
        }

        if (isWindy) {
          recommendations.alerts.push(
            "Windy conditions - secure loose clothing and accessories!",
          );
        }

        // Work environment adjustments
        if (userProfile.workEnvironment === "outdoor") {
          recommendations.alerts.push(
            "Working outdoors - choose weather-resistant materials",
          );
        }

        return recommendations;
      }

      // Convert state abbreviations to full names
      function getFullStateName(stateCode) {
        const stateNames = {
          'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
          'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
          'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
          'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
          'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
          'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
          'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
          'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
          'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
          'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',
          'DC': 'Washington D.C.'
        };
        return stateNames[stateCode] || stateCode;
      }

      // Convert country codes to full names for common countries
      function getFullCountryName(countryCode) {
        const countryNames = {
          'US': 'United States',
          'CA': 'Canada',
          'GB': 'United Kingdom',
          'AU': 'Australia',
          'DE': 'Germany',
          'FR': 'France',
          'ES': 'Spain',
          'IT': 'Italy',
          'NL': 'Netherlands',
          'JP': 'Japan',
          'KR': 'South Korea',
          'IN': 'India',
          'BR': 'Brazil',
          'MX': 'Mexico',
          'AR': 'Argentina',
          'ZA': 'South Africa',
          'NG': 'Nigeria',
          'EG': 'Egypt',
          'CN': 'China',
          'TH': 'Thailand',
          'SG': 'Singapore',
          'NZ': 'New Zealand',
          'NO': 'Norway',
          'SE': 'Sweden',
          'DK': 'Denmark',
          'FI': 'Finland',
          'IE': 'Ireland',
          'CH': 'Switzerland',
          'AT': 'Austria',
          'BE': 'Belgium',
          'PT': 'Portugal',
          'GR': 'Greece',
          'PL': 'Poland',
          'CZ': 'Czech Republic',
          'HU': 'Hungary',
          'RO': 'Romania',
          'BG': 'Bulgaria',
          'HR': 'Croatia',
          'SI': 'Slovenia',
          'SK': 'Slovakia',
          'LT': 'Lithuania',
          'LV': 'Latvia',
          'EE': 'Estonia',
          'RU': 'Russia',
          'UA': 'Ukraine',
          'TR': 'Turkey',
          'IL': 'Israel',
          'AE': 'UAE',
          'SA': 'Saudi Arabia'
        };
        return countryNames[countryCode] || countryCode;
      }

      // Allow Enter key to search - with proper event handling
      document
        .getElementById("locationInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            e.preventDefault(); // Prevent form submission/page refresh
            e.stopPropagation(); // Stop event bubbling
            getWeather();
          }
        });

      // Also prevent any form submission if the input is somehow in a form
      document
        .getElementById("locationInput")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            getWeather();
          }
        });
    </script>
    <!-- Secure API deployment -->
  </body>
</html>
        
